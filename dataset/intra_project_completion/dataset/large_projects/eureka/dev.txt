["<s>", "public", "static", "EurekaEndpoint", "fromTargetUrl", "(", "final", "String", "targetUrl", ")", "{", "return", "new", "EurekaEndpoint", "(", ")", "{", "@", "Override", "public", "String", "getServiceUrl", "(", ")", "{", "return", "targetUrl", ";", "}", "@", "Override", "public", "String", "getHostName", "(", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "@", "Override", "public", "int", "getPort", "(", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "@", "Override", "public", "boolean", "isSecure", "(", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "@", "Override", "public", "String", "getRelativeUri", "(", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "@", "Override", "public", "int", "compareTo", "(", "Object", "o", ")", "{", "return", "targetUrl", ".", "compareTo", "(", "(", "(", "EurekaEndpoint", ")", "o", ")", ".", "getServiceUrl", "(", ")", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "public", "static", "List", "<", "EurekaEndpoint", ">", "createForServerList", "(", "List", "<", "String", ">", "hostNames", ",", "int", "port", ",", "boolean", "isSecure", ",", "String", "relativeUri", ")", "{", "if", "(", "hostNames", ".", "isEmpty", "(", ")", ")", "{", "return", "Collections", ".", "emptyList", "(", ")", ";", "}", "List", "<", "EurekaEndpoint", ">", "eurekaEndpoints", "=", "new", "ArrayList", "<", ">", "(", "hostNames", ".", "size", "(", ")", ")", ";", "for", "(", "String", "hostName", ":", "hostNames", ")", "{", "eurekaEndpoints", ".", "add", "(", "new", "DefaultEndpoint", "(", "hostName", ",", "port", ",", "isSecure", ",", "relativeUri", ")", ")", ";", "}", "return", "eurekaEndpoints", ";", "}", "</s>"]
["<s>", "public", "String", "getRegion", "(", ")", "{", "return", "region", ";", "}", "</s>"]
["<s>", "public", "static", "List", "<", "AwsEndpoint", ">", "createForServerList", "(", "List", "<", "String", ">", "hostNames", ",", "int", "port", ",", "boolean", "isSecure", ",", "String", "relativeUri", ",", "String", "region", ",", "String", "zone", ")", "{", "if", "(", "hostNames", ".", "isEmpty", "(", ")", ")", "{", "return", "Collections", ".", "emptyList", "(", ")", ";", "}", "List", "<", "AwsEndpoint", ">", "awsEndpoints", "=", "new", "ArrayList", "<", ">", "(", "hostNames", ".", "size", "(", ")", ")", ";", "for", "(", "String", "hostName", ":", "hostNames", ")", "{", "awsEndpoints", ".", "add", "(", "new", "AwsEndpoint", "(", "hostName", ",", "port", ",", "isSecure", ",", "relativeUri", ",", "region", ",", "zone", ")", ")", ";", "}", "return", "awsEndpoints", ";", "}", "</s>"]
["<s>", "public", "B", "withClientIdentity", "(", "AbstractEurekaIdentity", "clientIdentity", ")", "{", "this", ".", "clientIdentity", "=", "clientIdentity", ";", "return", "self", "(", ")", ";", "}", "</s>"]
["<s>", "public", "static", "TransportClientFactory", "createFactory", "(", "final", "TransportClientFactory", "delegateFactory", ")", "{", "final", "Map", "<", "RequestType", ",", "EurekaHttpClientRequestMetrics", ">", "metricsByRequestType", "=", "initializeMetrics", "(", ")", ";", "final", "ExceptionsMetric", "exceptionMetrics", "=", "new", "ExceptionsMetric", "(", "EurekaClientNames", ".", "METRIC_TRANSPORT_PREFIX", "+", "\"", "<STR_LIT>", "\"", ")", ";", "return", "new", "TransportClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", "EurekaEndpoint", "endpoint", ")", "{", "return", "new", "MetricsCollectingEurekaHttpClient", "(", "delegateFactory", ".", "newClient", "(", "endpoint", ")", ",", "metricsByRequestType", ",", "exceptionMetrics", ",", "false", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "shutdownMetrics", "(", "metricsByRequestType", ")", ";", "exceptionMetrics", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "public", "static", "JerseyEurekaHttpClientFactory", "create", "(", "EurekaClientConfig", "clientConfig", ",", "InstanceInfo", "myInstanceInfo", ",", "boolean", "isSecure", ",", "AbstractEurekaIdentity", "clientIdentity", ")", "{", "JerseyEurekaHttpClientFactoryBuilder", "clientBuilder", "=", "newBuilder", "(", ")", ".", "withMyInstanceInfo", "(", "myInstanceInfo", ")", ".", "withUserAgent", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withAllowRedirect", "(", "clientConfig", ".", "allowRedirects", "(", ")", ")", ".", "withConnectionTimeout", "(", "clientConfig", ".", "getEurekaServerConnectTimeoutSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ".", "withReadTimeout", "(", "clientConfig", ".", "getEurekaServerReadTimeoutSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ".", "withMaxConnectionsPerHost", "(", "clientConfig", ".", "getEurekaServerTotalConnectionsPerHost", "(", ")", ")", ".", "withMaxTotalConnections", "(", "clientConfig", ".", "getEurekaServerTotalConnections", "(", ")", ")", ".", "withConnectionIdleTimeout", "(", "clientConfig", ".", "getEurekaConnectionIdleTimeoutSeconds", "(", ")", ")", ".", "withEncoder", "(", "clientConfig", ".", "getEncoderName", "(", ")", ")", ".", "withDecoder", "(", "clientConfig", ".", "getDecoderName", "(", ")", ",", "clientConfig", ".", "getClientDataAccept", "(", ")", ")", ".", "withClientIdentity", "(", "clientIdentity", ")", ";", "if", "(", "isSecure", "&", "&", "\"", "<STR_LIT>", "\"", ".", "equals", "(", "System", ".", "getProperty", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withSystemSSLConfiguration", "(", ")", ";", "}", "else", "if", "(", "clientConfig", ".", "getProxyHost", "(", ")", "!", "=", "null", "&", "&", "clientConfig", ".", "getProxyPort", "(", ")", "!", "=", "null", ")", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withProxy", "(", "clientConfig", ".", "getProxyHost", "(", ")", ",", "Integer", ".", "parseInt", "(", "clientConfig", ".", "getProxyPort", "(", ")", ")", ",", "clientConfig", ".", "getProxyUserName", "(", ")", ",", "clientConfig", ".", "getProxyPassword", "(", ")", ")", ";", "}", "else", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "return", "clientBuilder", ".", "build", "(", ")", ";", "}", "</s>"]
["<s>", "public", "static", "JerseyEurekaHttpClientFactory", "create", "(", "EurekaClientConfig", "clientConfig", ",", "InstanceInfo", "myInstanceInfo", ",", "boolean", "isSecure", ")", "{", "return", "create", "(", "clientConfig", ",", "myInstanceInfo", ",", "isSecure", ",", "new", "EurekaClientIdentity", "(", "myInstanceInfo", ".", "getIPAddr", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testReconnectIsEnforcedAtConfiguredInterval", "(", ")", "throws", "Exception", "{", "final", "AtomicReference", "<", "EurekaHttpClient", ">", "clientRef", "=", "new", "AtomicReference", "<", ">", "(", "firstClient", ")", ";", "when", "(", "factory", ".", "newClient", "(", ")", ")", ".", "thenAnswer", "(", "new", "Answer", "<", "EurekaHttpClient", ">", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "answer", "(", "InvocationOnMock", "invocation", ")", "throws", "Throwable", "{", "return", "clientRef", ".", "get", "(", ")", ";", "}", "}", ")", ";", "SessionedEurekaHttpClient", "httpClient", "=", "new", "SessionedEurekaHttpClient", "(", "factory", ",", "1", ")", ";", "httpClient", ".", "getApplications", "(", ")", ";", "verify", "(", "firstClient", ",", "times", "(", "1", ")", ")", ".", "getApplications", "(", ")", ";", "clientRef", ".", "set", "(", "secondClient", ")", ";", "Thread", ".", "sleep", "(", "<NUM_LIT:2>", ")", ";", "httpClient", ".", "getApplications", "(", ")", ";", "verify", "(", "secondClient", ",", "times", "(", "1", ")", ")", ".", "getApplications", "(", ")", ";", "}", "</s>"]
["<s>", "public", "static", "TransportClientFactory", "createFactory", "(", "final", "TransportClientFactory", "delegateFactory", ")", "{", "final", "DnsServiceImpl", "dnsService", "=", "new", "DnsServiceImpl", "(", ")", ";", "return", "new", "TransportClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", "EurekaEndpoint", "endpoint", ")", "{", "return", "new", "RedirectingEurekaHttpClient", "(", "endpoint", ".", "getServiceUrl", "(", ")", ",", "delegateFactory", ",", "dnsService", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "delegateFactory", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "private", "void", "scheduleServerEndpointTask", "(", "String", "zone", ")", "{", "eurekaServiceUrls", ".", "set", "(", "timedGetDiscoveryServiceUrls", "(", "zone", ")", ")", ";", "scheduler", ".", "scheduleWithFixedDelay", "(", "getServiceUrlUpdateTask", "(", "zone", ")", ",", "clientConfig", ".", "getEurekaServiceUrlPollIntervalSeconds", "(", ")", ",", "clientConfig", ".", "getEurekaServiceUrlPollIntervalSeconds", "(", ")", ",", "TimeUnit", ".", "SECONDS", ")", ";", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "EurekaHttpClientFactory", "newEurekaHttpClientFactory", "=", "null", ";", "EurekaHttpClient", "newEurekaHttpClient", "=", "null", ";", "try", "{", "newEurekaHttpClientFactory", "=", "EurekaHttpClients", ".", "createStandardClientFactory", "(", "clientConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "new", "ApplicationsResolver", ".", "ApplicationsSource", "(", ")", "{", "@", "Override", "public", "Applications", "getApplications", "(", "int", "stalenessThreshold", ",", "TimeUnit", "timeUnit", ")", "{", "long", "thresholdInMs", "=", "TimeUnit", ".", "MILLISECONDS", ".", "convert", "(", "stalenessThreshold", ",", "timeUnit", ")", ";", "long", "delay", "=", "getLastSuccessfulRegistryFetchTimePeriod", "(", ")", ";", "if", "(", "delay", ">", "thresholdInMs", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "thresholdInMs", ",", "delay", ")", ";", "return", "null", ";", "}", "else", "{", "return", "localRegionApps", ".", "get", "(", ")", ";", "}", "}", "}", ",", "scheduler", ",", "clusterResolverExecutor", ")", ";", "newEurekaHttpClient", "=", "newEurekaHttpClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "this", ".", "eurekaHttpClientFactory", "=", "newEurekaHttpClientFactory", ";", "this", ".", "eurekaHttpClient", "=", "newEurekaHttpClient", ";", "}", "}", "</s>"]
["<s>", "@", "com", ".", "netflix", ".", "servo", ".", "annotations", ".", "Monitor", "(", "name", "=", "METRIC_REGISTRY_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "private", "long", "getLastSuccessfulRegistryFetchTimePeriodInternal", "(", ")", "{", "long", "delay", "=", "getLastSuccessfulHeartbeatTimePeriod", "(", ")", ";", "registryStalenessMonitor", ".", "update", "(", "delay", ")", ";", "return", "delay", ";", "}", "</s>"]
["<s>", "public", "static", "AwsEndpoint", "instanceInfoToEndpoint", "(", "EurekaClientConfig", "clientConfig", ",", "InstanceInfo", "instanceInfo", ")", "{", "String", "zone", "=", "null", ";", "DataCenterInfo", "dataCenterInfo", "=", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "if", "(", "dataCenterInfo", "instanceof", "AmazonInfo", ")", "{", "zone", "=", "(", "(", "AmazonInfo", ")", "dataCenterInfo", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "availabilityZone", ")", ";", "}", "return", "new", "AwsEndpoint", "(", "instanceInfo", ".", "getHostName", "(", ")", ",", "instanceInfo", ".", "getPort", "(", ")", ",", "false", ",", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ",", "clientConfig", ".", "getRegion", "(", ")", ",", "zone", ")", ";", "}", "</s>"]
["<s>", "private", "<", "T", ">", "boolean", "validResponse", "(", "EurekaHttpResponse", "<", "T", ">", "response", ")", "{", "if", "(", "response", "=", "=", "null", ")", "{", "return", "false", ";", "}", "int", "responseCode", "=", "response", ".", "getStatusCode", "(", ")", ";", "return", "responseCode", ">", "=", "<NUM_LIT>", "&", "&", "responseCode", "<", "<NUM_LIT>", ";", "}", "</s>"]
["<s>", "static", "ClusterResolver", "<", "AwsEndpoint", ">", "createStandardClusterResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "InstanceInfo", "myInstanceInfo", ",", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ",", "ScheduledExecutorService", "executorService", ",", "ThreadPoolExecutor", "threadPoolExecutor", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "ClusterResolver", "bootstrapResolver", "=", "new", "LegacyClusterResolver", "(", "clientConfig", ",", "myZone", ")", ";", "EurekaHttpResolver", "remoteResolver", "=", "new", "EurekaHttpResolver", "(", "clientConfig", ",", "myInstanceInfo", ",", "bootstrapResolver", ",", "clientConfig", ".", "getReadClusterAppName", "(", ")", ")", ";", "ApplicationsResolver", "localResolver", "=", "new", "ApplicationsResolver", "(", "clientConfig", ",", "applicationsSource", ")", ";", "ClusterResolver", "<", "AwsEndpoint", ">", "compoundResolver", "=", "new", "ClusterResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "clientConfig", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "result", "=", "localResolver", ".", "getClusterEndpoints", "(", ")", ";", "if", "(", "result", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "remoteResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "return", "result", ";", "}", "}", ";", "return", "new", "AsyncResolver", "<", ">", "(", "clientConfig", ",", "new", "ZoneAffinityClusterResolver", "(", "compoundResolver", ",", "myZone", ",", "true", ")", ",", "executorService", ",", "threadPoolExecutor", ")", ";", "}", "</s>"]
["<s>", "public", "static", "EurekaHttpClientFactory", "createStandardClientFactory", "(", "EurekaClientConfig", "clientConfig", ",", "EurekaTransportConfig", "transportConfig", ",", "InstanceInfo", "myInstanceInfo", ",", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "ClosableResolver", "resolver", "=", "createStandardClusterResolver", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "applicationsSource", ")", ";", "return", "createStandardClientFactory", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "resolver", ")", ";", "}", "</s>"]
["<s>", "static", "ClosableResolver", "<", "AwsEndpoint", ">", "createStandardClusterResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ",", "final", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "ClusterResolver", "bootstrapResolver", "=", "new", "LegacyClusterResolver", "(", "clientConfig", ",", "myZone", ")", ";", "final", "EurekaHttpResolver", "remoteResolver", "=", "new", "EurekaHttpResolver", "(", "clientConfig", ",", "myInstanceInfo", ",", "bootstrapResolver", ",", "transportConfig", ".", "getReadClusterVip", "(", ")", ")", ";", "final", "ApplicationsResolver", "localResolver", "=", "new", "ApplicationsResolver", "(", "clientConfig", ",", "transportConfig", ",", "applicationsSource", ")", ";", "ClusterResolver", "<", "AwsEndpoint", ">", "compoundResolver", "=", "new", "ClusterResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "clientConfig", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "result", "=", "localResolver", ".", "getClusterEndpoints", "(", ")", ";", "if", "(", "result", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "remoteResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "return", "result", ";", "}", "}", ";", "final", "AsyncResolver", "<", "AwsEndpoint", ">", "asyncResolver", "=", "new", "AsyncResolver", "<", ">", "(", "transportConfig", ",", "new", "ZoneAffinityClusterResolver", "(", "compoundResolver", ",", "myZone", ",", "true", ")", ")", ";", "return", "new", "ClosableResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "asyncResolver", ".", "shutdown", "(", ")", ";", "remoteResolver", ".", "shutdown", "(", ")", ";", "}", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "asyncResolver", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "return", "asyncResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "static", "<", "T", "extends", "EurekaEndpoint", ">", "ClosableResolver", "<", "T", ">", "wrap", "(", "final", "ClusterResolver", "<", "T", ">", "clusterResolver", ")", "{", "if", "(", "clusterResolver", "instanceof", "ClosableResolver", ")", "{", "return", "(", "ClosableResolver", ")", "clusterResolver", ";", "}", "return", "new", "ClosableResolver", "<", "T", ">", "(", ")", "{", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "}", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "clusterResolver", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "T", ">", "getClusterEndpoints", "(", ")", "{", "return", "clusterResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "public", "static", "ServerStatusEvaluator", "httpSuccessEvaluator", "(", ")", "{", "return", "HTTP_SUCCESS_EVALUATOR", ";", "}", "</s>"]
["<s>", "public", "ApplicationInfoManager", "getApplicationInfoManager", "(", ")", "{", "return", "applicationInfoManager", ";", "}", "</s>"]
["<s>", "public", "EurekaHttpClient", "getRequestHandler", "(", ")", "{", "return", "requestHandler", ";", "}", "</s>"]
["<s>", "public", "SimpleEurekaHttpServer", "getEurekaHttpServer", "(", ")", "{", "return", "eurekaHttpServer", ";", "}", "</s>"]
["<s>", "void", "doWarmUp", "(", ")", "{", "Future", "future", "=", "null", ";", "try", "{", "future", "=", "threadPoolExecutor", ".", "submit", "(", "updateTask", ")", ";", "future", ".", "get", "(", "transportConfig", ".", "getAsyncResolverWarmupTimeoutMs", "(", ")", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "finally", "{", "if", "(", "future", "!", "=", "null", ")", "{", "future", ".", "cancel", "(", "true", ")", ";", "}", "}", "}", "</s>"]
["<s>", "private", "static", "AbstractEurekaIdentity", "resolverIdentity", "(", "final", "String", "id", ")", "{", "return", "new", "AbstractEurekaIdentity", "(", ")", "{", "@", "Override", "public", "String", "getName", "(", ")", "{", "return", "EurekaHttpResolver", ".", "class", ".", "getSimpleName", "(", ")", ";", "}", "@", "Override", "public", "String", "getVersion", "(", ")", "{", "return", "\"", "<STR_LIT:1.0>", "\"", ";", "}", "@", "Nullable", "@", "Override", "public", "String", "getId", "(", ")", "{", "return", "id", ";", "}", "@", "Override", "public", "String", "toString", "(", ")", "{", "return", "getName", "(", ")", "+", "\"", "<STR_LIT:->", "\"", "+", "getVersion", "(", ")", "+", "\"", "<STR_LIT:->", "\"", "+", "getId", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "static", "ClosableResolver", "<", "AwsEndpoint", ">", "createStandardClusterResolver", "(", "final", "EurekaHttpResolver", "remoteResolver", ",", "final", "ApplicationsResolver", "localResolver", ",", "final", "EurekaClientConfig", "clientConfig", ",", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "ClusterResolver", "<", "AwsEndpoint", ">", "compoundResolver", "=", "new", "ClusterResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "clientConfig", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "result", "=", "localResolver", ".", "getClusterEndpoints", "(", ")", ";", "if", "(", "result", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "remoteResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "return", "result", ";", "}", "}", ";", "final", "AsyncResolver", "<", "AwsEndpoint", ">", "asyncResolver", "=", "new", "AsyncResolver", "<", ">", "(", "transportConfig", ",", "new", "ZoneAffinityClusterResolver", "(", "compoundResolver", ",", "myZone", ",", "true", ")", ")", ";", "return", "new", "ClosableResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "asyncResolver", ".", "shutdown", "(", ")", ";", "remoteResolver", ".", "shutdown", "(", ")", ";", "}", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "asyncResolver", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "return", "asyncResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "when", "(", "transportConfig", ".", "getAsyncExecutorThreadPoolSize", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT:3>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverRefreshIntervalMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverWarmupTimeoutMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT:10>", ")", ";", "resolver", "=", "spy", "(", "new", "AsyncResolver", "(", "transportConfig", ",", "delegateResolver", ")", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "shutDown", "(", ")", "{", "resolver", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHappyCase", "(", ")", "{", "List", "delegateReturns1", "=", "new", "ArrayList", "(", "SampleCluster", ".", "UsEast1a", ".", "builder", "(", ")", ".", "withServerPool", "(", "<NUM_LIT:2>", ")", ".", "build", "(", ")", ")", ";", "List", "delegateReturns2", "=", "new", "ArrayList", "(", "SampleCluster", ".", "UsEast1b", ".", "builder", "(", ")", ".", "withServerPool", "(", "<NUM_LIT:3>", ")", ".", "build", "(", ")", ")", ";", "when", "(", "delegateResolver", ".", "getClusterEndpoints", "(", ")", ")", ".", "thenReturn", "(", "delegateReturns1", ")", ".", "thenReturn", "(", "delegateReturns2", ")", ";", "List", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "delegateReturns1", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "delegateResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "resolver", ",", "times", "(", "1", ")", ")", ".", "doWarmUp", "(", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "delegateReturns1", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "delegateResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "resolver", ",", "times", "(", "1", ")", ")", ".", "doWarmUp", "(", ")", ";", "verify", "(", "delegateResolver", ",", "timeout", "(", "<NUM_LIT:1000>", ")", ".", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "delegateReturns2", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "delegateResolver", ",", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "resolver", ",", "times", "(", "1", ")", ")", ".", "doWarmUp", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testDelegateFailureAtWarmUp", "(", ")", "{", "when", "(", "delegateResolver", ".", "getClusterEndpoints", "(", ")", ")", ".", "thenReturn", "(", "null", ")", ";", "List", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "isEmpty", "(", ")", ",", "is", "(", "true", ")", ")", ";", "verify", "(", "delegateResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "resolver", ",", "times", "(", "1", ")", ")", ".", "doWarmUp", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "when", "(", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "transportConfig", ".", "getApplicationsResolverDataStalenessThresholdSeconds", "(", ")", ")", ".", "thenReturn", "(", "1", ")", ";", "applications", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:5>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "vipAddress", "=", "applications", ".", "getRegisteredApplications", "(", "\"", "<STR_LIT>", "\"", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "when", "(", "transportConfig", ".", "getReadClusterVip", "(", ")", ")", ".", "thenReturn", "(", "vipAddress", ")", ";", "resolver", "=", "new", "ApplicationsResolver", "(", "clientConfig", ",", "transportConfig", ",", "applicationsSource", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHappyCase", "(", ")", "{", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "applications", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testVipDoesNotExist", "(", ")", "{", "vipAddress", "=", "\"", "<STR_LIT>", "\"", ";", "when", "(", "transportConfig", ".", "getReadClusterVip", "(", ")", ")", ".", "thenReturn", "(", "vipAddress", ")", ";", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "applications", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "isEmpty", "(", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testStaleData", "(", ")", "{", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "null", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "isEmpty", "(", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "when", "(", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "applications", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:5>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "vipAddress", "=", "applications", ".", "getRegisteredApplications", "(", "\"", "<STR_LIT>", "\"", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "when", "(", "clientFactory", ".", "newClient", "(", ")", ")", ".", "thenReturn", "(", "httpClient", ")", ";", "when", "(", "httpClient", ".", "getVip", "(", "vipAddress", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications", ")", ".", "build", "(", ")", ")", ";", "resolver", "=", "new", "EurekaHttpResolver", "(", "clientConfig", ",", "clientFactory", ",", "vipAddress", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "resolver", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHappyCase", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "httpClient", ",", "times", "(", "1", ")", ")", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testNoValidDataFromRemoteServer", "(", ")", "{", "Applications", "newApplications", "=", "new", "Applications", "(", ")", ";", "for", "(", "Application", "application", ":", "applications", ".", "getRegisteredApplications", "(", ")", ")", "{", "if", "(", "!", "application", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ".", "equals", "(", "vipAddress", ")", ")", "{", "newApplications", ".", "addApplication", "(", "application", ")", ";", "}", "}", "when", "(", "httpClient", ".", "getVip", "(", "vipAddress", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "newApplications", ")", ".", "build", "(", ")", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "isEmpty", "(", ")", ",", "is", "(", "true", ")", ")", ";", "verify", "(", "httpClient", ",", "times", "(", "1", ")", ")", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testErrorResponseFromRemoteServer", "(", ")", "{", "when", "(", "httpClient", ".", "getVip", "(", "vipAddress", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "(", "Applications", ")", "null", ")", ".", "build", "(", ")", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "isEmpty", "(", ")", ",", "is", "(", "true", ")", ")", ";", "verify", "(", "httpClient", ",", "times", "(", "1", ")", ")", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testShutdown", "(", ")", "{", "resolver", ".", "shutdown", "(", ")", ";", "verify", "(", "clientFactory", ",", "times", "(", "1", ")", ")", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testCanonicalResolver", "(", ")", "throws", "Exception", "{", "when", "(", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "transportConfig", ".", "getAsyncExecutorThreadPoolSize", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT:3>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverRefreshIntervalMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverWarmupTimeoutMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "Applications", "applications", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:5>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "String", "vipAddress", "=", "applications", ".", "getRegisteredApplications", "(", "\"", "<STR_LIT>", "\"", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", "=", "mock", "(", "ApplicationsResolver", ".", "ApplicationsSource", ".", "class", ")", ";", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "null", ")", ".", "thenReturn", "(", "applications", ")", ";", "EurekaHttpClientFactory", "remoteResolverClientFactory", "=", "mock", "(", "EurekaHttpClientFactory", ".", "class", ")", ";", "EurekaHttpClient", "httpClient", "=", "mock", "(", "EurekaHttpClient", ".", "class", ")", ";", "when", "(", "remoteResolverClientFactory", ".", "newClient", "(", ")", ")", ".", "thenReturn", "(", "httpClient", ")", ";", "when", "(", "httpClient", ".", "getVip", "(", "vipAddress", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications", ")", ".", "build", "(", ")", ")", ";", "EurekaHttpResolver", "remoteResolver", "=", "spy", "(", "new", "TestEurekaHttpResolver", "(", "clientConfig", ",", "remoteResolverClientFactory", ",", "vipAddress", ")", ")", ";", "when", "(", "transportConfig", ".", "getReadClusterVip", "(", ")", ")", ".", "thenReturn", "(", "vipAddress", ")", ";", "ApplicationsResolver", "localResolver", "=", "spy", "(", "new", "ApplicationsResolver", "(", "clientConfig", ",", "transportConfig", ",", "applicationsSource", ")", ")", ";", "ClosableResolver", "resolver", "=", "null", ";", "try", "{", "resolver", "=", "EurekaHttpClients", ".", "createStandardClusterResolver", "(", "remoteResolver", ",", "localResolver", ",", "clientConfig", ",", "transportConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ";", "List", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "remoteResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "localResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "applicationsSource", ",", "timeout", "(", "<NUM_LIT:1000>", ")", ".", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "remoteResolver", ",", "times", "(", "1", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "verify", "(", "localResolver", ",", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getClusterEndpoints", "(", ")", ";", "}", "finally", "{", "if", "(", "resolver", "!", "=", "null", ")", "{", "resolver", ".", "shutdown", "(", ")", ";", "verify", "(", "remoteResolver", ",", "times", "(", "1", ")", ")", ".", "shutdown", "(", ")", ";", "}", "}", "}", "</s>"]
["<s>", "@", "BeforeClass", "public", "static", "void", "setupClass", "(", ")", "throws", "IOException", "{", "eurekaHttpServer", "=", "new", "SimpleEurekaHttpServer", "(", "requestHandler", ")", ";", "when", "(", "requestHandler", ".", "register", "(", "any", "(", "InstanceInfo", ".", "class", ")", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "status", "(", "<NUM_LIT>", ")", ")", ";", "when", "(", "requestHandler", ".", "cancel", "(", "MY_APPLICATION_NAME", ",", "MY_INSTANCE_ID", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "status", "(", "<NUM_LIT>", ")", ")", ";", "when", "(", "requestHandler", ".", "sendHeartBeat", "(", "MY_APPLICATION_NAME", ",", "MY_INSTANCE_ID", ",", "null", ",", "null", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "InstanceInfo", ".", "class", ")", ".", "build", "(", ")", ")", ";", "when", "(", "requestHandler", ".", "getApplications", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "APPLICATIONS", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "when", "(", "requestHandler", ".", "getDelta", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "APPLICATIONS_DELTA", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "AfterClass", "public", "static", "void", "tearDownClass", "(", ")", "{", "if", "(", "eurekaHttpServer", "!", "=", "null", ")", "{", "eurekaHttpServer", ".", "shutdown", "(", ")", ";", "}", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testEurekaClientLifecycle", "(", ")", "throws", "Exception", "{", "Injector", "injector", "=", "LifecycleInjector", ".", "builder", "(", ")", ".", "withModules", "(", "new", "AbstractModule", "(", ")", "{", "@", "Override", "protected", "void", "configure", "(", ")", "{", "bind", "(", "EurekaInstanceConfig", ".", "class", ")", ".", "to", "(", "LocalEurekaInstanceConfig", ".", "class", ")", ";", "bind", "(", "EurekaClientConfig", ".", "class", ")", ".", "to", "(", "LocalEurekaClientConfig", ".", "class", ")", ";", "}", "}", ")", ".", "build", "(", ")", ".", "createInjector", "(", ")", ";", "LifecycleManager", "lifecycleManager", "=", "injector", ".", "getInstance", "(", "LifecycleManager", ".", "class", ")", ";", "lifecycleManager", ".", "start", "(", ")", ";", "EurekaClient", "client", "=", "injector", ".", "getInstance", "(", "EurekaClient", ".", "class", ")", ";", "verify", "(", "requestHandler", ",", "timeout", "(", "TIMEOUT_MS", ")", ".", "atLeast", "(", "1", ")", ")", ".", "register", "(", "any", "(", "InstanceInfo", ".", "class", ")", ")", ";", "verify", "(", "requestHandler", ",", "timeout", "(", "TIMEOUT_MS", ")", ".", "times", "(", "1", ")", ")", ".", "getApplications", "(", ")", ";", "verify", "(", "requestHandler", ",", "timeout", "(", "TIMEOUT_MS", ")", ".", "atLeast", "(", "1", ")", ")", ".", "getDelta", "(", ")", ";", "assertThat", "(", "countInstances", "(", "client", ".", "getApplications", "(", ")", ")", ",", "is", "(", "equalTo", "(", "1", ")", ")", ")", ";", "lifecycleManager", ".", "close", "(", ")", ";", "verify", "(", "requestHandler", ",", "times", "(", "1", ")", ")", ".", "cancel", "(", "MY_APPLICATION_NAME", ",", "MY_INSTANCE_ID", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testBackupRegistryInjection", "(", ")", "throws", "Exception", "{", "final", "BackupRegistry", "backupRegistry", "=", "mock", "(", "BackupRegistry", ".", "class", ")", ";", "when", "(", "backupRegistry", ".", "fetchRegistry", "(", ")", ")", ".", "thenReturn", "(", "APPLICATIONS", ")", ";", "Injector", "injector", "=", "LifecycleInjector", ".", "builder", "(", ")", ".", "withModules", "(", "new", "AbstractModule", "(", ")", "{", "@", "Override", "protected", "void", "configure", "(", ")", "{", "bind", "(", "EurekaInstanceConfig", ".", "class", ")", ".", "to", "(", "LocalEurekaInstanceConfig", ".", "class", ")", ";", "bind", "(", "EurekaClientConfig", ".", "class", ")", ".", "to", "(", "BadServerEurekaClientConfig", ".", "class", ")", ";", "bind", "(", "BackupRegistry", ".", "class", ")", ".", "toInstance", "(", "backupRegistry", ")", ";", "}", "}", ")", ".", "build", "(", ")", ".", "createInjector", "(", ")", ";", "LifecycleManager", "lifecycleManager", "=", "injector", ".", "getInstance", "(", "LifecycleManager", ".", "class", ")", ";", "lifecycleManager", ".", "start", "(", ")", ";", "EurekaClient", "client", "=", "injector", ".", "getInstance", "(", "EurekaClient", ".", "class", ")", ";", "verify", "(", "backupRegistry", ",", "atLeast", "(", "1", ")", ")", ".", "fetchRegistry", "(", ")", ";", "assertThat", "(", "countInstances", "(", "client", ".", "getApplications", "(", ")", ")", ",", "is", "(", "equalTo", "(", "1", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testNameSpaceInjection", "(", ")", "throws", "Exception", "{", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "SERVICE_URI", ")", ";", "Injector", "injector", "=", "LifecycleInjector", ".", "builder", "(", ")", ".", "withBootstrapModule", "(", "new", "BootstrapModule", "(", ")", "{", "@", "Override", "public", "void", "configure", "(", "BootstrapBinder", "binder", ")", "{", "binder", ".", "bind", "(", "String", ".", "class", ")", ".", "annotatedWith", "(", "EurekaNamespace", ".", "class", ")", ".", "toInstance", "(", "\"", "<STR_LIT:.>", "\"", ")", ";", "}", "}", ")", ".", "build", "(", ")", ".", "createInjector", "(", ")", ";", "DefaultEurekaClientConfig", "clientConfig", "=", "injector", ".", "getInstance", "(", "DefaultEurekaClientConfig", ".", "class", ")", ";", "List", "<", "String", ">", "serviceUrls", "=", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "\"", "<STR_LIT>", "\"", ")", ";", "assertThat", "(", "serviceUrls", ".", "get", "(", "0", ")", ",", "is", "(", "equalTo", "(", "SERVICE_URI", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Deprecated", "public", "static", "String", "getZone", "(", "InstanceInfo", "myInfo", ")", "{", "String", "[", "]", "availZones", "=", "staticClientConfig", ".", "getAvailabilityZones", "(", "staticClientConfig", ".", "getRegion", "(", ")", ")", ";", "return", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInfo", ")", ";", "}", "</s>"]
["<s>", "@", "Deprecated", "public", "static", "String", "getRegion", "(", ")", "{", "String", "region", "=", "staticClientConfig", ".", "getRegion", "(", ")", ";", "if", "(", "region", "=", "=", "null", ")", "{", "region", "=", "\"", "<STR_LIT>", "\"", ";", "}", "region", "=", "region", ".", "trim", "(", ")", ".", "toLowerCase", "(", ")", ";", "return", "region", ";", "}", "</s>"]
["<s>", "@", "Deprecated", "public", "static", "List", "<", "String", ">", "getEurekaServiceUrlsFromConfig", "(", "String", "instanceZone", ",", "boolean", "preferSameZone", ")", "{", "return", "EndpointUtils", ".", "getServiceUrlsFromConfig", "(", "staticClientConfig", ",", "instanceZone", ",", "preferSameZone", ")", ";", "}", "</s>"]
["<s>", "private", "boolean", "shouldUseExperimentalTransportForRegistration", "(", ")", "{", "if", "(", "registrationClient", "=", "=", "null", ")", "{", "return", "false", ";", "}", "String", "enabled", "=", "clientConfig", ".", "getExperimental", "(", "\"", "<STR_LIT>", "\"", ")", ";", "return", "enabled", "!", "=", "null", "&", "&", "\"", "<STR_LIT>", "\"", ".", "equalsIgnoreCase", "(", "enabled", ")", ";", "}", "</s>"]
["<s>", "public", "static", "EurekaHttpClientFactory", "queryClientFactory", "(", "EurekaClientConfig", "clientConfig", ",", "EurekaTransportConfig", "transportConfig", ",", "InstanceInfo", "myInstanceInfo", ",", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "ClosableResolver", "queryResolver", "=", "queryClientResolver", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "applicationsSource", ")", ";", "return", "canonicalClientFactory", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "queryResolver", ")", ";", "}", "</s>"]
["<s>", "public", "static", "EurekaHttpClientFactory", "registrationClientFactory", "(", "EurekaClientConfig", "clientConfig", ",", "EurekaTransportConfig", "transportConfig", ",", "InstanceInfo", "myInstanceInfo", ")", "{", "ClusterResolver", "registrationResolver", "=", "registrationClientResolver", "(", "clientConfig", ",", "myInstanceInfo", ")", ";", "return", "canonicalClientFactory", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "registrationResolver", ")", ";", "}", "</s>"]
["<s>", "static", "ClusterResolver", "<", "AwsEndpoint", ">", "registrationClientResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "return", "new", "LegacyClusterResolver", "(", "clientConfig", ",", "myZone", ")", ";", "}", "</s>"]
["<s>", "public", "static", "Map", "<", "String", ",", "List", "<", "String", ">", ">", "getServiceUrlsMapFromConfig", "(", "EurekaClientConfig", "clientConfig", ",", "String", "instanceZone", ",", "boolean", "preferSameZone", ")", "{", "Map", "<", "String", ",", "List", "<", "String", ">", ">", "orderedUrls", "=", "new", "LinkedHashMap", "<", ">", "(", ")", ";", "String", "region", "=", "getRegion", "(", "clientConfig", ")", ";", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "if", "(", "availZones", "=", "=", "null", "|", "|", "availZones", ".", "length", "=", "=", "0", ")", "{", "availZones", "=", "new", "String", "[", "1", "]", ";", "availZones", "[", "0", "]", "=", "DEFAULT_ZONE", ";", "}", "logger", ".", "debug", "(", "\"", "<STR_LIT>", "\"", ",", "region", ",", "Arrays", ".", "toString", "(", "availZones", ")", ")", ";", "int", "myZoneOffset", "=", "getZoneOffset", "(", "instanceZone", ",", "preferSameZone", ",", "availZones", ")", ";", "String", "zone", "=", "availZones", "[", "myZoneOffset", "]", ";", "List", "<", "String", ">", "serviceUrls", "=", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "zone", ")", ";", "if", "(", "serviceUrls", "!", "=", "null", ")", "{", "orderedUrls", ".", "put", "(", "zone", ",", "serviceUrls", ")", ";", "}", "int", "currentOffset", "=", "myZoneOffset", "=", "=", "(", "availZones", ".", "length", "-", "1", ")", "?", "0", ":", "(", "myZoneOffset", "+", "1", ")", ";", "while", "(", "currentOffset", "!", "=", "myZoneOffset", ")", "{", "zone", "=", "availZones", "[", "currentOffset", "]", ";", "serviceUrls", "=", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "zone", ")", ";", "if", "(", "serviceUrls", "!", "=", "null", ")", "{", "orderedUrls", ".", "put", "(", "zone", ",", "serviceUrls", ")", ";", "}", "if", "(", "currentOffset", "=", "=", "(", "availZones", ".", "length", "-", "1", ")", ")", "{", "currentOffset", "=", "0", ";", "}", "else", "{", "currentOffset", "+", "+", ";", "}", "}", "if", "(", "orderedUrls", ".", "size", "(", ")", "<", "1", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "return", "orderedUrls", ";", "}", "</s>"]
["<s>", "public", "static", "EurekaHttpClientFactory", "registrationClientFactory", "(", "ClusterResolver", "bootstrapResolver", ",", "TransportClientFactory", "transportClientFactory", ",", "EurekaTransportConfig", "transportConfig", ")", "{", "return", "canonicalClientFactory", "(", "transportConfig", ",", "bootstrapResolver", ",", "transportClientFactory", ")", ";", "}", "</s>"]
["<s>", "static", "EurekaHttpClientFactory", "canonicalClientFactory", "(", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "ClusterResolver", "<", "EurekaEndpoint", ">", "clusterResolver", ",", "final", "TransportClientFactory", "transportClientFactory", ")", "{", "return", "new", "EurekaHttpClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", ")", "{", "return", "new", "SessionedEurekaHttpClient", "(", "RetryableEurekaHttpClient", ".", "createFactory", "(", "clusterResolver", ",", "RedirectingEurekaHttpClient", ".", "createFactory", "(", "transportClientFactory", ")", ",", "ServerStatusEvaluators", ".", "legacyEvaluator", "(", ")", ")", ",", "transportConfig", ".", "getSessionedClientReconnectIntervalSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "wrapClosable", "(", "clusterResolver", ")", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "static", "ClusterResolver", "<", "AwsEndpoint", ">", "defaultBootstrapResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myRegion", "=", "clientConfig", ".", "getRegion", "(", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "ClusterResolver", "<", "AwsEndpoint", ">", "newResolver", ";", "if", "(", "clientConfig", ".", "shouldUseDnsForFetchingServiceUrls", "(", ")", ")", "{", "String", "discoveryDnsName", "=", "\"", "<STR_LIT:.>", "\"", "+", "myRegion", "+", "<CHAR_LIT:.>", "+", "clientConfig", ".", "getEurekaServerDNSName", "(", ")", ";", "newResolver", "=", "new", "DnsTxtRecordClusterResolver", "(", "myRegion", ",", "discoveryDnsName", ",", "true", ",", "Integer", ".", "parseInt", "(", "clientConfig", ".", "getEurekaServerPort", "(", ")", ")", ",", "false", ",", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ")", ";", "}", "else", "{", "Map", "<", "String", ",", "List", "<", "String", ">", ">", "serviceUrls", "=", "EndpointUtils", ".", "getServiceUrlsMapFromConfig", "(", "clientConfig", ",", "myZone", ",", "clientConfig", ".", "shouldPreferSameZoneEureka", "(", ")", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "new", "ArrayList", "<", ">", "(", "serviceUrls", ".", "size", "(", ")", ")", ";", "for", "(", "String", "zone", ":", "serviceUrls", ".", "keySet", "(", ")", ")", "{", "for", "(", "String", "url", ":", "serviceUrls", ".", "get", "(", "zone", ")", ")", "{", "try", "{", "URI", "serviceURI", "=", "new", "URI", "(", "url", ")", ";", "endpoints", ".", "add", "(", "new", "AwsEndpoint", "(", "serviceURI", ".", "getHost", "(", ")", ",", "serviceURI", ".", "getPort", "(", ")", ",", "\"", "<STR_LIT>", "\"", ".", "equalsIgnoreCase", "(", "serviceURI", ".", "getSchemeSpecificPart", "(", ")", ")", ",", "serviceURI", ".", "getPath", "(", ")", ",", "myRegion", ",", "zone", ")", ")", ";", "}", "catch", "(", "URISyntaxException", "ignore", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "url", ")", ";", "}", "}", "}", "newResolver", "=", "new", "StaticClusterResolver", "<", ">", "(", "myRegion", ",", "endpoints", ")", ";", "}", "return", "newResolver", ";", "}", "</s>"]
["<s>", "static", "ClosableResolver", "<", "AwsEndpoint", ">", "queryClientResolver", "(", "final", "ClusterResolver", "bootstrapResolver", ",", "final", "TransportClientFactory", "transportClientFactory", ",", "final", "EurekaClientConfig", "clientConfig", ",", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ",", "final", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "final", "EurekaHttpResolver", "remoteResolver", "=", "new", "EurekaHttpResolver", "(", "clientConfig", ",", "bootstrapResolver", ",", "transportClientFactory", ",", "transportConfig", ".", "getReadClusterVip", "(", ")", ")", ";", "final", "ApplicationsResolver", "localResolver", "=", "new", "ApplicationsResolver", "(", "clientConfig", ",", "transportConfig", ",", "applicationsSource", ")", ";", "return", "queryClientResolver", "(", "remoteResolver", ",", "localResolver", ",", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ")", ";", "}", "</s>"]
["<s>", "@", "Monitor", "(", "name", "=", "METRIC_RESOLVER_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "public", "long", "getLastLoadTimestamp", "(", ")", "{", "return", "lastLoadTimestamp", "<", "0", "?", "0", ":", "System", ".", "currentTimeMillis", "(", ")", "-", "lastLoadTimestamp", ";", "}", "</s>"]
["<s>", "@", "Monitor", "(", "name", "=", "METRIC_TRANSPORT_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "public", "long", "getCurrentSessionDuration", "(", ")", "{", "return", "lastReconnectTimeStamp", "<", "0", "?", "0", ":", "System", ".", "currentTimeMillis", "(", ")", "-", "lastReconnectTimeStamp", ";", "}", "</s>"]
["<s>", "void", "shutdown", "(", ")", "{", "if", "(", "registrationClientFactory", "!", "=", "null", ")", "{", "registrationClientFactory", ".", "shutdown", "(", ")", ";", "}", "if", "(", "queryClientFactory", "!", "=", "null", ")", "{", "queryClientFactory", ".", "shutdown", "(", ")", ";", "}", "if", "(", "registrationClient", "!", "=", "null", ")", "{", "registrationClient", ".", "shutdown", "(", ")", ";", "}", "if", "(", "queryClient", "!", "=", "null", ")", "{", "queryClient", ".", "shutdown", "(", ")", ";", "}", "if", "(", "transportClientFactory", "!", "=", "null", ")", "{", "transportClientFactory", ".", "shutdown", "(", ")", ";", "}", "if", "(", "bootstrapResolver", "!", "=", "null", ")", "{", "bootstrapResolver", ".", "shutdown", "(", ")", ";", "}", "}", "</s>"]
["<s>", "private", "void", "scheduleServerEndpointTask", "(", "EurekaTransport", "eurekaTransport", ",", "String", "zone", ")", "{", "eurekaServiceUrls", ".", "set", "(", "timedGetDiscoveryServiceUrls", "(", "zone", ")", ")", ";", "scheduler", ".", "scheduleWithFixedDelay", "(", "getServiceUrlUpdateTask", "(", "zone", ")", ",", "clientConfig", ".", "getEurekaServiceUrlPollIntervalSeconds", "(", ")", ",", "clientConfig", ".", "getEurekaServiceUrlPollIntervalSeconds", "(", ")", ",", "TimeUnit", ".", "SECONDS", ")", ";", "eurekaTransport", ".", "bootstrapResolver", "=", "EurekaHttpClients", ".", "newBootstrapResolver", "(", "clientConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ";", "eurekaTransport", ".", "transportClientFactory", "=", "EurekaHttpClients", ".", "newTransportClientFactory", "(", "clientConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ";", "if", "(", "clientConfig", ".", "shouldRegisterWithEureka", "(", ")", ")", "{", "EurekaHttpClientFactory", "newRegistrationClientFactory", "=", "null", ";", "EurekaHttpClient", "newRegistrationClient", "=", "null", ";", "try", "{", "newRegistrationClientFactory", "=", "EurekaHttpClients", ".", "registrationClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "transportConfig", ")", ";", "newRegistrationClient", "=", "newRegistrationClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "registrationClientFactory", "=", "newRegistrationClientFactory", ";", "eurekaTransport", ".", "registrationClient", "=", "newRegistrationClient", ";", "}", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "EurekaHttpClientFactory", "newQueryClientFactory", "=", "null", ";", "EurekaHttpClient", "newQueryClient", "=", "null", ";", "try", "{", "newQueryClientFactory", "=", "EurekaHttpClients", ".", "queryClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "clientConfig", ",", "transportConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "new", "ApplicationsResolver", ".", "ApplicationsSource", "(", ")", "{", "@", "Override", "public", "Applications", "getApplications", "(", "int", "stalenessThreshold", ",", "TimeUnit", "timeUnit", ")", "{", "long", "thresholdInMs", "=", "TimeUnit", ".", "MILLISECONDS", ".", "convert", "(", "stalenessThreshold", ",", "timeUnit", ")", ";", "long", "delay", "=", "getLastSuccessfulRegistryFetchTimePeriod", "(", ")", ";", "if", "(", "delay", ">", "thresholdInMs", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "thresholdInMs", ",", "delay", ")", ";", "return", "null", ";", "}", "else", "{", "return", "localRegionApps", ".", "get", "(", ")", ";", "}", "}", "}", ")", ";", "newQueryClient", "=", "newQueryClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "queryClientFactory", "=", "newQueryClientFactory", ";", "eurekaTransport", ".", "queryClient", "=", "newQueryClient", ";", "}", "}", "</s>"]
["<s>", "private", "void", "scheduleTask", "(", "long", "delay", ")", "{", "executorService", ".", "schedule", "(", "backgroundTask", ",", "delay", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "}", "</s>"]
["<s>", "@", "com", ".", "netflix", ".", "servo", ".", "annotations", ".", "Monitor", "(", "name", "=", "METRIC_REGISTRATION_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "private", "long", "getLastSuccessfulHeartbeatTimePeriodInternal", "(", ")", "{", "long", "delay", "=", "getLastSuccessfulHeartbeatTimePeriod", "(", ")", ";", "heartbeatStalenessMonitor", ".", "update", "(", "delay", ")", ";", "return", "delay", ";", "}", "</s>"]
["<s>", "LongGauge", "[", "]", "getGauges", "(", ")", "{", "return", "gauges", ";", "}", "</s>"]
["<s>", "private", "long", "computeStalenessMonitorDelay", "(", "long", "delay", ")", "{", "if", "(", "delay", "<", "0", ")", "{", "return", "System", ".", "currentTimeMillis", "(", ")", "-", "initTimestampMs", ";", "}", "else", "{", "return", "delay", ";", "}", "}", "</s>"]
["<s>", "@", "Monitor", "(", "name", "=", "METRIC_RESOLVER_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "public", "long", "getEndpointsSize", "(", ")", "{", "return", "resultsRef", ".", "get", "(", ")", ".", "size", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "when", "(", "clientConfig", ".", "shouldUseDnsForFetchingServiceUrls", "(", ")", ")", ".", "thenReturn", "(", "true", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "clientConfig", ".", "getAvailabilityZones", "(", "\"", "<STR_LIT>", "\"", ")", ")", ".", "thenReturn", "(", "new", "String", "[", "]", "{", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", "}", ")", ";", "when", "(", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "\"", "<STR_LIT>", "\"", ")", ")", ".", "thenReturn", "(", "endpointsC", ")", ";", "when", "(", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "\"", "<STR_LIT>", "\"", ")", ")", ".", "thenReturn", "(", "endpointsD", ")", ";", "when", "(", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "\"", "<STR_LIT>", "\"", ")", ")", ".", "thenReturn", "(", "endpointsE", ")", ";", "InstanceInfo", "instanceInfo", "=", "new", "InstanceInfo", ".", "Builder", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ".", "setDataCenterInfo", "(", "new", "MyDataCenterInfo", "(", "DataCenterInfo", ".", "Name", ".", "MyOwn", ")", ")", ".", "build", "(", ")", ";", "resolver", "=", "new", "ConfigClusterResolver", "(", "clientConfig", ",", "instanceInfo", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHappyCase", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "<NUM_LIT:6>", ")", ")", ";", "}", "</s>"]
["<s>", "private", "List", "<", "AwsEndpoint", ">", "getClusterEndpointsFromDns", "(", ")", "{", "String", "region", "=", "getRegion", "(", ")", ";", "String", "discoveryDnsName", "=", "\"", "<STR_LIT:.>", "\"", "+", "region", "+", "<CHAR_LIT:.>", "+", "clientConfig", ".", "getEurekaServerDNSName", "(", ")", ";", "int", "port", "=", "Integer", ".", "parseInt", "(", "clientConfig", ".", "getEurekaServerPort", "(", ")", ")", ";", "DnsTxtRecordClusterResolver", "dnsResolver", "=", "new", "DnsTxtRecordClusterResolver", "(", "region", ",", "discoveryDnsName", ",", "true", ",", "port", ",", "false", ",", "clientConfig", ".", "getEurekaServerURLContext", "(", ")", ")", ";", "return", "dnsResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "</s>"]
["<s>", "private", "List", "<", "AwsEndpoint", ">", "getClusterEndpointsFromConfig", "(", ")", "{", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "Map", "<", "String", ",", "List", "<", "String", ">", ">", "serviceUrls", "=", "EndpointUtils", ".", "getServiceUrlsMapFromConfig", "(", "clientConfig", ",", "myZone", ",", "clientConfig", ".", "shouldPreferSameZoneEureka", "(", ")", ")", ";", "List", "<", "AwsEndpoint", ">", "endpoints", "=", "new", "ArrayList", "<", ">", "(", ")", ";", "for", "(", "String", "zone", ":", "serviceUrls", ".", "keySet", "(", ")", ")", "{", "for", "(", "String", "url", ":", "serviceUrls", ".", "get", "(", "zone", ")", ")", "{", "try", "{", "URI", "serviceURI", "=", "new", "URI", "(", "url", ")", ";", "endpoints", ".", "add", "(", "new", "AwsEndpoint", "(", "serviceURI", ".", "getHost", "(", ")", ",", "serviceURI", ".", "getPort", "(", ")", ",", "\"", "<STR_LIT>", "\"", ".", "equalsIgnoreCase", "(", "serviceURI", ".", "getSchemeSpecificPart", "(", ")", ")", ",", "serviceURI", ".", "getPath", "(", ")", ",", "getRegion", "(", ")", ",", "zone", ")", ")", ";", "}", "catch", "(", "URISyntaxException", "ignore", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "url", ")", ";", "}", "}", "}", "if", "(", "logger", ".", "isDebugEnabled", "(", ")", ")", "{", "logger", ".", "debug", "(", "\"", "<STR_LIT>", "\"", ",", "endpoints", ")", ";", "}", "return", "endpoints", ";", "}", "</s>"]
["<s>", "public", "static", "String", "join", "(", "String", ".", ".", ".", "values", ")", "{", "if", "(", "values", "=", "=", "null", "|", "|", "values", ".", "length", "=", "=", "0", ")", "{", "return", "null", ";", "}", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ")", ";", "for", "(", "String", "value", ":", "values", ")", "{", "sb", ".", "append", "(", "<CHAR_LIT:U+002C>", ")", ".", "append", "(", "value", ")", ";", "}", "return", "sb", ".", "substring", "(", "1", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetApplicationsWithRemoteRegionRequest", "(", ")", "throws", "Exception", "{", "Applications", "apps", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:2>", ",", "1", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "when", "(", "requestHandler", ".", "getApplications", "(", "REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "createResponse", "(", "apps", ")", ")", ";", "EurekaHttpResponse", "<", "Applications", ">", "httpResponse", "=", "getEurekaHttpClient", "(", ")", ".", "getApplications", "(", "REMOTE_REGION", ")", ";", "verifyResponseOkWithEntity", "(", "apps", ",", "httpResponse", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetDeltaWithRemoteRegionRequest", "(", ")", "throws", "Exception", "{", "Applications", "delta", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:2>", ",", "1", ")", ".", "build", "(", ")", ".", "takeDelta", "(", "<NUM_LIT:2>", ")", ";", "when", "(", "requestHandler", ".", "getDelta", "(", "REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "createResponse", "(", "delta", ")", ")", ";", "EurekaHttpResponse", "<", "Applications", ">", "httpResponse", "=", "getEurekaHttpClient", "(", ")", ".", "getDelta", "(", "REMOTE_REGION", ")", ";", "verifyResponseOkWithEntity", "(", "delta", ",", "httpResponse", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetVipWithRemoteRegionRequest", "(", ")", "throws", "Exception", "{", "Applications", "vipApps", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "1", ",", "<NUM_LIT:2>", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "String", "vipAddress", "=", "vipApps", ".", "getRegisteredApplications", "(", ")", ".", "get", "(", "0", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "when", "(", "requestHandler", ".", "getVip", "(", "vipAddress", ",", "REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "createResponse", "(", "vipApps", ")", ")", ";", "EurekaHttpResponse", "<", "Applications", ">", "httpResponse", "=", "getEurekaHttpClient", "(", ")", ".", "getVip", "(", "vipAddress", ",", "REMOTE_REGION", ")", ";", "verifyResponseOkWithEntity", "(", "vipApps", ",", "httpResponse", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetSecureVipWithRemoteRegionRequest", "(", ")", "throws", "Exception", "{", "Applications", "vipApps", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "1", ",", "<NUM_LIT:2>", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "String", "secureVipAddress", "=", "vipApps", ".", "getRegisteredApplications", "(", ")", ".", "get", "(", "0", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getSecureVipAddress", "(", ")", ";", "when", "(", "requestHandler", ".", "getSecureVip", "(", "secureVipAddress", ",", "REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "createResponse", "(", "vipApps", ")", ")", ";", "EurekaHttpResponse", "<", "Applications", ">", "httpResponse", "=", "getEurekaHttpClient", "(", ")", ".", "getSecureVip", "(", "secureVipAddress", ",", "REMOTE_REGION", ")", ";", "verifyResponseOkWithEntity", "(", "vipApps", ",", "httpResponse", ")", ";", "}", "</s>"]
["<s>", "@", "com", ".", "netflix", ".", "servo", ".", "annotations", ".", "Monitor", "(", "name", "=", "METRIC_REGISTRY_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "public", "int", "localRegistrySize", "(", ")", "{", "return", "registrySize", ";", "}", "</s>"]
["<s>", "public", "int", "size", "(", ")", "{", "return", "instances", ".", "size", "(", ")", ";", "}", "</s>"]
["<s>", "public", "int", "size", "(", ")", "{", "int", "result", "=", "0", ";", "for", "(", "Application", "application", ":", "applications", ")", "{", "result", "+", "=", "application", ".", "size", "(", ")", ";", "}", "return", "result", ";", "}", "</s>"]
["<s>", "public", "B", "withSSLContext", "(", "SSLContext", "sslContext", ")", "{", "this", ".", "sslContext", "=", "sslContext", ";", "return", "self", "(", ")", ";", "}", "</s>"]
["<s>", "public", "static", "JerseyEurekaHttpClientFactoryBuilder", "experimentalBuilder", "(", ")", "{", "return", "new", "JerseyEurekaHttpClientFactoryBuilder", "(", "true", ")", ";", "}", "</s>"]
["<s>", "private", "JerseyEurekaHttpClientFactory", "buildLegacy", "(", ")", "{", "EurekaJerseyClientBuilder", "clientBuilder", "=", "new", "EurekaJerseyClientBuilder", "(", ")", ".", "withClientName", "(", "clientName", ")", ".", "withUserAgent", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withConnectionTimeout", "(", "connectionTimeout", ")", ".", "withReadTimeout", "(", "readTimeout", ")", ".", "withMaxConnectionsPerHost", "(", "maxConnectionsPerHost", ")", ".", "withMaxTotalConnections", "(", "maxTotalConnections", ")", ".", "withConnectionIdleTimeout", "(", "connectionIdleTimeout", ")", ".", "withEncoderWrapper", "(", "encoderWrapper", ")", ".", "withDecoderWrapper", "(", "decoderWrapper", ")", ";", "EurekaJerseyClient", "jerseyClient", "=", "clientBuilder", ".", "build", "(", ")", ";", "ApacheHttpClient4", "discoveryApacheClient", "=", "jerseyClient", ".", "getClient", "(", ")", ";", "addFilters", "(", "discoveryApacheClient", ")", ";", "return", "new", "JerseyEurekaHttpClientFactory", "(", "jerseyClient", ",", "allowRedirect", ")", ";", "}", "</s>"]
["<s>", "private", "JerseyEurekaHttpClientFactory", "buildExperimental", "(", ")", "{", "ThreadSafeClientConnManager", "cm", "=", "createConnectionManager", "(", ")", ";", "ClientConfig", "clientConfig", "=", "new", "DefaultApacheHttpClient4Config", "(", ")", ";", "if", "(", "proxyHost", "!", "=", "null", ")", "{", "addProxyConfiguration", "(", "clientConfig", ")", ";", "}", "DiscoveryJerseyProvider", "discoveryJerseyProvider", "=", "new", "DiscoveryJerseyProvider", "(", "encoderWrapper", ",", "decoderWrapper", ")", ";", "clientConfig", ".", "getSingletons", "(", ")", ".", "add", "(", "discoveryJerseyProvider", ")", ";", "cm", ".", "setDefaultMaxPerRoute", "(", "maxConnectionsPerHost", ")", ";", "cm", ".", "setMaxTotal", "(", "maxTotalConnections", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ApacheHttpClient4Config", ".", "PROPERTY_CONNECTION_MANAGER", ",", "cm", ")", ";", "String", "fullUserAgentName", "=", "(", "userAgent", "=", "=", "null", "?", "clientName", ":", "userAgent", ")", "+", "\"", "<STR_LIT>", "\"", "+", "buildVersion", "(", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "CoreProtocolPNames", ".", "USER_AGENT", ",", "fullUserAgentName", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ClientConfig", ".", "PROPERTY_FOLLOW_REDIRECTS", ",", "Boolean", ".", "FALSE", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ClientPNames", ".", "HANDLE_REDIRECTS", ",", "Boolean", ".", "FALSE", ")", ";", "ApacheHttpClient4", "apacheClient", "=", "ApacheHttpClient4", ".", "create", "(", "clientConfig", ")", ";", "addFilters", "(", "apacheClient", ")", ";", "return", "new", "JerseyEurekaHttpClientFactory", "(", "apacheClient", ",", "allowRedirect", ")", ";", "}", "</s>"]
["<s>", "private", "ThreadSafeClientConnManager", "createConnectionManager", "(", ")", "{", "try", "{", "ThreadSafeClientConnManager", "connectionManager", ";", "if", "(", "sslContext", "!", "=", "null", ")", "{", "SchemeSocketFactory", "socketFactory", "=", "new", "SSLSocketFactory", "(", "sslContext", ",", "new", "AllowAllHostnameVerifier", "(", ")", ")", ";", "SchemeRegistry", "sslSchemeRegistry", "=", "new", "SchemeRegistry", "(", ")", ";", "sslSchemeRegistry", ".", "register", "(", "new", "Scheme", "(", "\"", "<STR_LIT>", "\"", ",", "<NUM_LIT>", ",", "socketFactory", ")", ")", ";", "connectionManager", "=", "new", "ThreadSafeClientConnManager", "(", "sslSchemeRegistry", ")", ";", "}", "else", "{", "connectionManager", "=", "new", "ThreadSafeClientConnManager", "(", ")", ";", "}", "return", "connectionManager", ";", "}", "catch", "(", "Exception", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "}", "</s>"]
["<s>", "private", "void", "addProxyConfiguration", "(", "ClientConfig", "clientConfig", ")", "{", "if", "(", "proxyUserName", "!", "=", "null", "&", "&", "proxyPassword", "!", "=", "null", ")", "{", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ApacheHttpClient4Config", ".", "PROPERTY_PROXY_USERNAME", ",", "proxyUserName", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ApacheHttpClient4Config", ".", "PROPERTY_PROXY_PASSWORD", ",", "proxyPassword", ")", ";", "}", "else", "{", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ApacheHttpClient4Config", ".", "PROPERTY_PROXY_USERNAME", ",", "\"", "<STR_LIT>", "\"", ")", ";", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "ApacheHttpClient4Config", ".", "PROPERTY_PROXY_PASSWORD", ",", "\"", "<STR_LIT>", "\"", ")", ";", "}", "clientConfig", ".", "getProperties", "(", ")", ".", "put", "(", "DefaultApacheHttpClient4Config", ".", "PROPERTY_PROXY_URI", ",", "\"", "<STR_LIT>", "\"", "+", "proxyHost", "+", "<CHAR_LIT::>", "+", "proxyPort", ")", ";", "}", "</s>"]
["<s>", "private", "void", "addFilters", "(", "ApacheHttpClient4", "discoveryApacheClient", ")", "{", "discoveryApacheClient", ".", "addFilter", "(", "new", "GZIPContentEncodingFilter", "(", "false", ")", ")", ";", "String", "ip", "=", "myInstanceInfo", "=", "=", "null", "?", "null", ":", "myInstanceInfo", ".", "getIPAddr", "(", ")", ";", "AbstractEurekaIdentity", "identity", "=", "clientIdentity", "=", "=", "null", "?", "new", "EurekaClientIdentity", "(", "ip", ")", ":", "clientIdentity", ";", "discoveryApacheClient", ".", "addFilter", "(", "new", "EurekaIdentityHeaderFilter", "(", "identity", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Monitor", "(", "name", "=", "METRIC_TRANSPORT_PREFIX", "+", "\"", "<STR_LIT>", "\"", ",", "description", "=", "\"", "<STR_LIT>", "\"", ",", "type", "=", "DataSourceType", ".", "GAUGE", ")", "public", "long", "getQuarantineSetSize", "(", ")", "{", "return", "quarantineSet", ".", "size", "(", ")", ";", "}", "</s>"]
["<s>", "protected", "long", "randomizeSessionDuration", "(", "long", "sessionDurationMs", ")", "{", "long", "delta", "=", "(", "long", ")", "(", "sessionDurationMs", "*", "(", "random", ".", "nextDouble", "(", ")", "-", "<NUM_LIT>", ")", ")", ";", "return", "sessionDurationMs", "+", "delta", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGoodRegistration", "(", ")", "throws", "Exception", "{", "InstanceInfo", "noIdInfo", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "Response", "response", "=", "applicationResource", ".", "addInstance", "(", "noIdInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testBadRegistration", "(", ")", "throws", "Exception", "{", "InstanceInfo", "instanceInfo", "=", "spy", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ";", "when", "(", "instanceInfo", ".", "getId", "(", ")", ")", ".", "thenReturn", "(", "null", ")", ";", "Response", "response", "=", "applicationResource", ".", "addInstance", "(", "instanceInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "instanceInfo", "=", "spy", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ";", "when", "(", "instanceInfo", ".", "getHostName", "(", ")", ")", ".", "thenReturn", "(", "null", ")", ";", "response", "=", "applicationResource", ".", "addInstance", "(", "instanceInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "instanceInfo", "=", "spy", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ";", "when", "(", "instanceInfo", ".", "getAppName", "(", ")", ")", ".", "thenReturn", "(", "null", ")", ";", "response", "=", "applicationResource", ".", "addInstance", "(", "instanceInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "}", "</s>"]
["<s>", "private", "boolean", "isBlank", "(", "String", "str", ")", "{", "return", "str", "=", "=", "null", "|", "|", "str", ".", "isEmpty", "(", ")", ";", "}", "</s>"]
["<s>", "public", "void", "shutdown", "(", ")", "{", "cleanIdle", "(", "0", ")", ";", "eurekaConnCleaner", ".", "shutdown", "(", ")", ";", "}", "</s>"]
["<s>", "private", "static", "void", "decompressResponse", "(", "ClientResponse", "response", ")", "{", "InputStream", "entityInputStream", "=", "response", ".", "getEntityInputStream", "(", ")", ";", "GZIPInputStream", "uncompressedIS", ";", "try", "{", "uncompressedIS", "=", "new", "GZIPInputStream", "(", "entityInputStream", ")", ";", "}", "catch", "(", "IOException", "ex", ")", "{", "try", "{", "entityInputStream", ".", "close", "(", ")", ";", "}", "catch", "(", "IOException", "ignored", ")", "{", "}", "throw", "new", "ClientHandlerException", "(", "ex", ")", ";", "}", "response", ".", "setEntityInputStream", "(", "uncompressedIS", ")", ";", "}", "</s>"]
["<s>", "public", "String", "resolveDefaultAddress", "(", "DataCenterInfo", "dataCenterInfo", ")", "{", "String", "result", "=", "getHostName", "(", "true", ")", ";", "if", "(", "dataCenterInfo", "instanceof", "AmazonInfo", ")", "{", "AmazonInfo", "amazonInfo", "=", "(", "AmazonInfo", ")", "dataCenterInfo", ";", "for", "(", "String", "name", ":", "getDefaultAddressResolutionOrder", "(", ")", ")", "{", "try", "{", "AmazonInfo", ".", "MetaDataKey", "key", "=", "AmazonInfo", ".", "MetaDataKey", ".", "valueOf", "(", "name", ")", ";", "String", "address", "=", "amazonInfo", ".", "get", "(", "key", ")", ";", "if", "(", "address", "!", "=", "null", "&", "&", "!", "address", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "address", ";", "break", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "name", ",", "e", ")", ";", "}", "}", "}", "else", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "return", "result", ";", "}", "</s>"]
["<s>", "@", "JsonIgnore", "public", "String", "getDefaultAddress", "(", ")", "{", "return", "hostName", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "instanceInfo", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "this", ".", "applicationInfoManager", "=", "new", "ApplicationInfoManager", "(", "config", ",", "instanceInfo", ")", ";", "when", "(", "config", ".", "getDefaultAddressResolutionOrder", "(", ")", ")", ".", "thenReturn", "(", "new", "String", "[", "]", "{", "publicHostname", ".", "name", "(", ")", ",", "localIpv4", ".", "name", "(", ")", "}", ")", ";", "when", "(", "config", ".", "getHostName", "(", "anyBoolean", "(", ")", ")", ")", ".", "thenReturn", "(", "dummyDefault", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testRefreshDataCenterInfoWithAmazonInfo", "(", ")", "{", "AmazonInfo", "info", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "String", "newPublicHostname", "=", "\"", "<STR_LIT>", "\"", ";", "assertThat", "(", "instanceInfo", ".", "getDefaultAddress", "(", ")", ",", "is", "(", "not", "(", "newPublicHostname", ")", ")", ")", ";", "info", ".", "getMetadata", "(", ")", ".", "put", "(", "publicHostname", ".", "getName", "(", ")", ",", "newPublicHostname", ")", ";", "applicationInfoManager", ".", "refreshDataCenterInfoIfRequired", "(", ")", ";", "assertThat", "(", "instanceInfo", ".", "getDefaultAddress", "(", ")", ",", "is", "(", "newPublicHostname", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testRefreshDataCenterInfoWithMyDataCenterInfo", "(", ")", "{", "MyDataCenterInfo", "myDataCenterInfo", "=", "new", "MyDataCenterInfo", "(", "DataCenterInfo", ".", "Name", ".", "MyOwn", ")", ";", "instanceInfo", "=", "new", "InstanceInfo", ".", "Builder", "(", "instanceInfo", ")", ".", "setDataCenterInfo", "(", "myDataCenterInfo", ")", ".", "build", "(", ")", ";", "DataCenterInfo", "info", "=", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "assertThat", "(", "info", ",", "instanceOf", "(", "MyDataCenterInfo", ".", "class", ")", ")", ";", "applicationInfoManager", ".", "refreshDataCenterInfoIfRequired", "(", ")", ";", "assertThat", "(", "instanceInfo", ".", "getDefaultAddress", "(", ")", ",", "is", "(", "dummyDefault", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "{", "config", "=", "spy", "(", "new", "CloudInstanceConfig", "(", ")", ")", ";", "instanceInfo", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "when", "(", "config", ".", "getDefaultAddressResolutionOrder", "(", ")", ")", ".", "thenReturn", "(", "new", "String", "[", "]", "{", "publicHostname", ".", "name", "(", ")", ",", "localIpv4", ".", "name", "(", ")", "}", ")", ";", "when", "(", "config", ".", "getHostName", "(", "anyBoolean", "(", ")", ")", ")", ".", "thenReturn", "(", "dummyDefault", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testResolveDefaultAddress", "(", ")", "{", "AmazonInfo", "info", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "assertThat", "(", "config", ".", "resolveDefaultAddress", "(", "info", ")", ",", "is", "(", "info", ".", "get", "(", "publicHostname", ")", ")", ")", ";", "info", ".", "getMetadata", "(", ")", ".", "remove", "(", "publicHostname", ".", "getName", "(", ")", ")", ";", "assertThat", "(", "config", ".", "resolveDefaultAddress", "(", "info", ")", ",", "is", "(", "info", ".", "get", "(", "localIpv4", ")", ")", ")", ";", "info", ".", "getMetadata", "(", ")", ".", "remove", "(", "localIpv4", ".", "getName", "(", ")", ")", ";", "assertThat", "(", "config", ".", "resolveDefaultAddress", "(", "info", ")", ",", "is", "(", "dummyDefault", ")", ")", ";", "}", "</s>"]
["<s>", "@", "BeforeClass", "public", "static", "void", "setUpClass", "(", ")", "{", "System", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "}", "</s>"]
["<s>", "@", "AfterClass", "public", "static", "void", "tearDownClass", "(", ")", "{", "System", ".", "clearProperty", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testBadRegistrationOfDataCenterInfo", "(", ")", "throws", "Exception", "{", "try", "{", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "InstanceInfo", "instanceInfo", "=", "spy", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ";", "when", "(", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "thenReturn", "(", "new", "TestDataCenterInfo", "(", ")", ")", ";", "Response", "response", "=", "applicationResource", ".", "addInstance", "(", "instanceInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "instanceInfo", "=", "spy", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ";", "assertThat", "(", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ",", "instanceOf", "(", "AmazonInfo", ".", "class", ")", ")", ";", "(", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "getMetadata", "(", ")", ".", "remove", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ".", "getName", "(", ")", ")", ";", "response", "=", "applicationResource", ".", "addInstance", "(", "instanceInfo", ",", "false", "+", "\"", "\"", ")", ";", "assertThat", "(", "response", ".", "getStatus", "(", ")", ",", "is", "(", "<NUM_LIT>", ")", ")", ";", "}", "finally", "{", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "clearProperty", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "}", "</s>"]
["<s>", "private", "static", "boolean", "shouldUpdate", "(", "AmazonInfo", "newInfo", ",", "AmazonInfo", "oldInfo", ")", "{", "if", "(", "newInfo", ".", "getMetadata", "(", ")", ".", "isEmpty", "(", ")", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "return", "false", ";", "}", "else", "if", "(", "!", "newInfo", ".", "equals", "(", "oldInfo", ")", ")", "{", "int", "newKeySize", "=", "newInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ";", "int", "oldKeySize", "=", "oldInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ";", "if", "(", "newKeySize", "<", "oldKeySize", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "oldKeySize", ",", "newKeySize", ")", ";", "return", "false", ";", "}", "}", "return", "true", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAmazonInfoUpdate", "(", ")", "{", "AmazonInfo", "oldInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "newInfo1", "=", "oldInfo", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo1", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "AmazonInfo", "newInfo2", "=", "new", "AmazonInfo", "(", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo2", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "AmazonInfo", "newInfo3", "=", "new", "AmazonInfo", "(", ")", ";", "for", "(", "String", "key", ":", "oldInfo", ".", "getMetadata", "(", ")", ".", "keySet", "(", ")", ")", "{", "newInfo3", ".", "getMetadata", "(", ")", ".", "put", "(", "key", ",", "oldInfo", ".", "getMetadata", "(", ")", ".", "get", "(", "key", ")", ")", ";", "}", "int", "originalInfo3Size", "=", "newInfo3", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ";", "newInfo3", ".", "getMetadata", "(", ")", ".", "put", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ".", "getName", "(", ")", ",", "\"", "<STR_LIT>", "\"", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo3", ",", "oldInfo", ")", ",", "is", "(", "true", ")", ")", ";", "String", "newKey", "=", "\"", "<STR_LIT>", "\"", ";", "newInfo3", ".", "getMetadata", "(", ")", ".", "put", "(", "newKey", ",", "\"", "<STR_LIT>", "\"", ")", ";", "assertThat", "(", "newInfo3", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ",", "is", "(", "originalInfo3Size", "+", "1", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo3", ",", "oldInfo", ")", ",", "is", "(", "true", ")", ")", ";", "newInfo3", ".", "getMetadata", "(", ")", ".", "remove", "(", "newKey", ")", ";", "newInfo3", ".", "getMetadata", "(", ")", ".", "remove", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ".", "getName", "(", ")", ")", ";", "assertThat", "(", "newInfo3", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ",", "is", "(", "originalInfo3Size", "-", "1", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo3", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "}", "</s>"]
["<s>", "public", "boolean", "isEnabled", "(", ")", "{", "return", "enabled", ";", "}", "</s>"]
["<s>", "@", "JsonProperty", "(", "\"", "<STR_LIT>", "\"", ")", "public", "void", "withApplication", "(", "List", "<", "Application", ">", "applications", ")", "{", "this", ".", "applications", "=", "applications", ";", "}", "</s>"]
["<s>", "@", "JsonAnySetter", "public", "void", "with", "(", "String", "fieldName", ",", "Object", "value", ")", "{", "if", "(", "fieldName", ".", "startsWith", "(", "\"", "<STR_LIT>", "\"", ")", ")", "{", "version", "=", "value", "instanceof", "Number", "?", "(", "(", "Number", ")", "value", ")", ".", "longValue", "(", ")", ":", "Long", ".", "parseLong", "(", "(", "String", ")", "value", ")", ";", "}", "else", "if", "(", "fieldName", ".", "startsWith", "(", "\"", "<STR_LIT>", "\"", ")", ")", "{", "appsHashCode", "=", "(", "String", ")", "value", ";", "}", "}", "</s>"]
["<s>", "public", "Applications", "build", "(", ")", "{", "return", "new", "Applications", "(", "appsHashCode", ",", "version", ",", "applications", ")", ";", "}", "</s>"]
["<s>", "boolean", "isJacksonXmlOnClasspath", "(", ")", "{", "try", "{", "return", "DiscoveryJerseyProvider", ".", "class", ".", "getClassLoader", "(", ")", ".", "loadClass", "(", "\"", "<STR_LIT>", "\"", ")", "!", "=", "null", ";", "}", "catch", "(", "Exception", "ignore", ")", "{", "return", "false", ";", "}", "}", "</s>"]
["<s>", "private", "boolean", "isSupported", "(", "MediaType", "mediaType", ")", "{", "if", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ".", "isCompatible", "(", "mediaType", ")", ")", "{", "return", "true", ";", "}", "if", "(", "MediaType", ".", "APPLICATION_XML_TYPE", ".", "isCompatible", "(", "mediaType", ")", ")", "{", "return", "xmlDecoder", "!", "=", "null", ";", "}", "return", "false", ";", "}", "</s>"]
["<s>", "private", "static", "boolean", "isSupportedCharset", "(", "MediaType", "mediaType", ")", "{", "Map", "<", "String", ",", "String", ">", "parameters", "=", "mediaType", ".", "getParameters", "(", ")", ";", "if", "(", "parameters", "=", "=", "null", "|", "|", "parameters", ".", "isEmpty", "(", ")", ")", "{", "return", "true", ";", "}", "String", "charset", "=", "parameters", ".", "get", "(", "\"", "<STR_LIT>", "\"", ")", ";", "return", "charset", "=", "=", "null", "|", "|", "\"", "<STR_LIT:UTF-8>", "\"", ".", "equalsIgnoreCase", "(", "charset", ")", "|", "|", "\"", "<STR_LIT>", "\"", ".", "equalsIgnoreCase", "(", "charset", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testJsonEncodingDecoding", "(", ")", "throws", "Exception", "{", "testEncodingDecoding", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testXmlEncodingDecoding", "(", ")", "throws", "Exception", "{", "testEncodingDecoding", "(", "MediaType", ".", "APPLICATION_XML_TYPE", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testDecodingWithUtf8CharsetExplicitlySet", "(", ")", "throws", "Exception", "{", "Map", "<", "String", ",", "String", ">", "params", "=", "new", "HashMap", "<", ">", "(", ")", ";", "params", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT:UTF-8>", "\"", ")", ";", "testEncodingDecoding", "(", "new", "MediaType", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ",", "params", ")", ")", ";", "}", "</s>"]
["<s>", "private", "void", "testEncodingDecoding", "(", "MediaType", "mediaType", ")", "throws", "IOException", "{", "assertThat", "(", "jerseyProvider", ".", "isWriteable", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "mediaType", ")", ",", "is", "(", "true", ")", ")", ";", "ByteArrayOutputStream", "out", "=", "new", "ByteArrayOutputStream", "(", ")", ";", "jerseyProvider", ".", "writeTo", "(", "INSTANCE", ",", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "mediaType", ",", "null", ",", "out", ")", ";", "assertThat", "(", "jerseyProvider", ".", "isReadable", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "mediaType", ")", ",", "is", "(", "true", ")", ")", ";", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "out", ".", "toByteArray", "(", ")", ")", ";", "InstanceInfo", "decodedInstance", "=", "(", "InstanceInfo", ")", "jerseyProvider", ".", "readFrom", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "mediaType", ",", "null", ",", "in", ")", ";", "assertThat", "(", "decodedInstance", ",", "is", "(", "equalTo", "(", "INSTANCE", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testNonUtf8CharsetIsNotAccepted", "(", ")", "throws", "Exception", "{", "Map", "<", "String", ",", "String", ">", "params", "=", "new", "HashMap", "<", ">", "(", ")", ";", "params", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "MediaType", "mediaTypeWithNonSupportedCharset", "=", "new", "MediaType", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ",", "params", ")", ";", "assertThat", "(", "jerseyProvider", ".", "isReadable", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "mediaTypeWithNonSupportedCharset", ")", ",", "is", "(", "false", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testErrorHandlingIfXmlNotEnabled", "(", ")", "throws", "Exception", "{", "DiscoveryJerseyProvider", "jerseyProvider", "=", "new", "DiscoveryJerseyProvider", "(", "CodecWrappers", ".", "getEncoder", "(", "CodecWrappers", ".", "JacksonJson", ".", "class", ")", ",", "CodecWrappers", ".", "getDecoder", "(", "CodecWrappers", ".", "JacksonJson", ".", "class", ")", ")", "{", "@", "Override", "boolean", "isJacksonXmlOnClasspath", "(", ")", "{", "return", "false", ";", "}", "}", ";", "assertThat", "(", "jerseyProvider", ".", "isWriteable", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "MediaType", ".", "APPLICATION_XML_TYPE", ")", ",", "is", "(", "false", ")", ")", ";", "try", "{", "ByteArrayOutputStream", "out", "=", "new", "ByteArrayOutputStream", "(", ")", ";", "jerseyProvider", ".", "writeTo", "(", "INSTANCE", ",", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "MediaType", ".", "APPLICATION_XML_TYPE", ",", "null", ",", "out", ")", ";", "fail", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "catch", "(", "WebApplicationException", "e", ")", "{", "}", "assertThat", "(", "jerseyProvider", ".", "isReadable", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "MediaType", ".", "APPLICATION_XML_TYPE", ")", ",", "is", "(", "false", ")", ")", ";", "try", "{", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "new", "byte", "[", "0", "]", ")", ";", "jerseyProvider", ".", "readFrom", "(", "InstanceInfo", ".", "class", ",", "InstanceInfo", ".", "class", ",", "null", ",", "MediaType", ".", "APPLICATION_XML_TYPE", ",", "null", ",", "in", ")", ";", "fail", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "catch", "(", "WebApplicationException", "e", ")", "{", "}", "}", "</s>"]
["<s>", "private", "String", "toJson", "(", "Applications", "apps", ")", "throws", "IOException", "{", "return", "new", "EurekaJsonJacksonCodec", "(", ")", ".", "getObjectMapper", "(", "Applications", ".", "class", ")", ".", "writeValueAsString", "(", "apps", ")", ";", "}", "</s>"]
["<s>", "private", "void", "scheduleServerEndpointTask", "(", "EurekaTransport", "eurekaTransport", ",", "DiscoveryClientOptionalArgs", "args", ")", "{", "eurekaTransport", ".", "bootstrapResolver", "=", "EurekaHttpClients", ".", "newBootstrapResolver", "(", "clientConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ";", "Collection", "<", "ClientFilter", ">", "additionalFilters", "=", "args", "=", "=", "null", "?", "Collections", ".", "emptyList", "(", ")", ":", "args", ".", "additionalFilters", ";", "EurekaJerseyClient", "providedJerseyClient", "=", "args", "=", "=", "null", "?", "null", ":", "args", ".", "eurekaJerseyClient", ";", "eurekaTransport", ".", "transportClientFactory", "=", "providedJerseyClient", "=", "=", "null", "?", "EurekaHttpClients", ".", "newTransportClientFactory", "(", "clientConfig", ",", "additionalFilters", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ":", "EurekaHttpClients", ".", "newTransportClientFactory", "(", "additionalFilters", ",", "providedJerseyClient", ")", ";", "if", "(", "clientConfig", ".", "shouldRegisterWithEureka", "(", ")", ")", "{", "EurekaHttpClientFactory", "newRegistrationClientFactory", "=", "null", ";", "EurekaHttpClient", "newRegistrationClient", "=", "null", ";", "try", "{", "newRegistrationClientFactory", "=", "EurekaHttpClients", ".", "registrationClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "transportConfig", ")", ";", "newRegistrationClient", "=", "newRegistrationClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "registrationClientFactory", "=", "newRegistrationClientFactory", ";", "eurekaTransport", ".", "registrationClient", "=", "newRegistrationClient", ";", "}", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "EurekaHttpClientFactory", "newQueryClientFactory", "=", "null", ";", "EurekaHttpClient", "newQueryClient", "=", "null", ";", "try", "{", "newQueryClientFactory", "=", "EurekaHttpClients", ".", "queryClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "clientConfig", ",", "transportConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "new", "ApplicationsResolver", ".", "ApplicationsSource", "(", ")", "{", "@", "Override", "public", "Applications", "getApplications", "(", "int", "stalenessThreshold", ",", "TimeUnit", "timeUnit", ")", "{", "long", "thresholdInMs", "=", "TimeUnit", ".", "MILLISECONDS", ".", "convert", "(", "stalenessThreshold", ",", "timeUnit", ")", ";", "long", "delay", "=", "getLastSuccessfulRegistryFetchTimePeriod", "(", ")", ";", "if", "(", "delay", ">", "thresholdInMs", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "thresholdInMs", ",", "delay", ")", ";", "return", "null", ";", "}", "else", "{", "return", "localRegionApps", ".", "get", "(", ")", ";", "}", "}", "}", ")", ";", "newQueryClient", "=", "newQueryClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "queryClientFactory", "=", "newQueryClientFactory", ";", "eurekaTransport", ".", "queryClient", "=", "newQueryClient", ";", "}", "}", "</s>"]
["<s>", "public", "B", "withClientAccept", "(", "EurekaAccept", "eurekaAccept", ")", "{", "this", ".", "eurekaAccept", "=", "eurekaAccept", ";", "return", "self", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Deprecated", "public", "static", "TransportClientFactory", "newTransportClientFactory", "(", "final", "Collection", "<", "ClientFilter", ">", "additionalFilters", ",", "final", "EurekaJerseyClient", "providedJerseyClient", ")", "{", "ApacheHttpClient4", "apacheHttpClient", "=", "providedJerseyClient", ".", "getClient", "(", ")", ";", "if", "(", "additionalFilters", "!", "=", "null", ")", "{", "for", "(", "ClientFilter", "filter", ":", "additionalFilters", ")", "{", "if", "(", "filter", "!", "=", "null", ")", "{", "apacheHttpClient", ".", "addFilter", "(", "filter", ")", ";", "}", "}", "}", "final", "TransportClientFactory", "jerseyFactory", "=", "new", "JerseyEurekaHttpClientFactory", "(", "providedJerseyClient", ",", "false", ")", ";", "final", "TransportClientFactory", "metricsFactory", "=", "MetricsCollectingEurekaHttpClient", ".", "createFactory", "(", "jerseyFactory", ")", ";", "return", "new", "TransportClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", "EurekaEndpoint", "serviceUrl", ")", "{", "return", "metricsFactory", ".", "newClient", "(", "serviceUrl", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "metricsFactory", ".", "shutdown", "(", ")", ";", "jerseyFactory", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "public", "JerseyEurekaHttpClientFactoryBuilder", "withAdditionalFilters", "(", "Collection", "<", "ClientFilter", ">", "additionalFilters", ")", "{", "this", ".", "additionalFilters", "=", "additionalFilters", ";", "return", "this", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAddingAdditionalFilters", "(", ")", "throws", "Exception", "{", "TestFilter", "testFilter", "=", "new", "TestFilter", "(", ")", ";", "Collection", "<", "ClientFilter", ">", "additionalFilters", "=", "Arrays", ".", "asList", "(", "testFilter", ")", ";", "TransportClientFactory", "transportClientFactory", "=", "EurekaHttpClients", ".", "newTransportClientFactory", "(", "clientConfig", ",", "additionalFilters", ",", "MY_INSTANCE", ")", ";", "EurekaHttpClient", "client", "=", "transportClientFactory", ".", "newClient", "(", "clusterResolver", ".", "getClusterEndpoints", "(", ")", ".", "get", "(", "0", ")", ")", ";", "client", ".", "getApplication", "(", "\"", "<STR_LIT>", "\"", ")", ";", "assertThat", "(", "testFilter", ".", "await", "(", "<NUM_LIT:30>", ",", "TimeUnit", ".", "SECONDS", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "public", "boolean", "await", "(", "long", "timeout", ",", "TimeUnit", "unit", ")", "throws", "Exception", "{", "return", "latch", ".", "await", "(", "timeout", ",", "unit", ")", ";", "}", "</s>"]
["<s>", "public", "EncoderWrapper", "getEncoder", "(", ")", "{", "return", "encoder", ";", "}", "</s>"]
["<s>", "public", "DecoderWrapper", "getDecoder", "(", ")", "{", "return", "decoder", ";", "}", "</s>"]
["<s>", "@", "Nullable", "private", "static", "ISerializer", "getSerializer", "(", "@", "SuppressWarnings", "(", "\"", "<STR_LIT>", "\"", ")", "Class", "serializableClass", ")", "{", "ISerializer", "converter", "=", "null", ";", "Annotation", "annotation", "=", "serializableClass", ".", "getAnnotation", "(", "Serializer", ".", "class", ")", ";", "if", "(", "annotation", "!", "=", "null", ")", "{", "Serializer", "payloadConverter", "=", "(", "Serializer", ")", "annotation", ";", "String", "serializer", "=", "payloadConverter", ".", "value", "(", ")", ";", "if", "(", "serializer", "!", "=", "null", ")", "{", "converter", "=", "serializers", ".", "get", "(", "serializableClass", ")", ";", "if", "(", "converter", "=", "=", "null", ")", "{", "try", "{", "converter", "=", "(", "ISerializer", ")", "Class", ".", "forName", "(", "serializer", ")", ".", "newInstance", "(", ")", ";", "}", "catch", "(", "InstantiationException", "e", ")", "{", "LOGGER", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "catch", "(", "IllegalAccessException", "e", ")", "{", "LOGGER", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "catch", "(", "ClassNotFoundException", "e", ")", "{", "LOGGER", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "if", "(", "null", "!", "=", "converter", ")", "{", "serializers", ".", "put", "(", "serializableClass", ",", "converter", ")", ";", "}", "}", "}", "}", "return", "converter", ";", "}", "</s>"]
["<s>", "private", "boolean", "isSupportedMediaType", "(", "MediaType", "mediaType", ")", "{", "if", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ".", "isCompatible", "(", "mediaType", ")", ")", "{", "return", "true", ";", "}", "if", "(", "MediaType", ".", "APPLICATION_XML_TYPE", ".", "isCompatible", "(", "mediaType", ")", ")", "{", "return", "xmlDecoder", "!", "=", "null", ";", "}", "return", "false", ";", "}", "</s>"]
["<s>", "public", "static", "ClosableResolver", "<", "AwsEndpoint", ">", "newBootstrapResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ",", "final", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "if", "(", "COMPOSITE_BOOTSTRAP_STRATEGY", ".", "equals", "(", "transportConfig", ".", "getBootstrapResolverStrategy", "(", ")", ")", ")", "{", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "return", "compositeBootstrapResolver", "(", "clientConfig", ",", "transportConfig", ",", "myInstanceInfo", ",", "applicationsSource", ")", ";", "}", "else", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", "+", "\"", "<STR_LIT>", "\"", ")", ";", "}", "}", "return", "defaultBootstrapResolver", "(", "clientConfig", ",", "myInstanceInfo", ")", ";", "}", "</s>"]
["<s>", "static", "ClosableResolver", "<", "AwsEndpoint", ">", "compositeBootstrapResolver", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "EurekaTransportConfig", "transportConfig", ",", "final", "InstanceInfo", "myInstanceInfo", ",", "final", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", ")", "{", "final", "ConfigClusterResolver", "remoteResolver", "=", "new", "ConfigClusterResolver", "(", "clientConfig", ",", "myInstanceInfo", ")", ";", "final", "ApplicationsResolver", "localResolver", "=", "new", "ApplicationsResolver", "(", "clientConfig", ",", "transportConfig", ",", "applicationsSource", ",", "transportConfig", ".", "getWriteClusterVip", "(", ")", ")", ";", "ClusterResolver", "<", "AwsEndpoint", ">", "compoundResolver", "=", "new", "ClusterResolver", "<", "AwsEndpoint", ">", "(", ")", "{", "@", "Override", "public", "String", "getRegion", "(", ")", "{", "return", "clientConfig", ".", "getRegion", "(", ")", ";", "}", "@", "Override", "public", "List", "<", "AwsEndpoint", ">", "getClusterEndpoints", "(", ")", "{", "List", "<", "AwsEndpoint", ">", "result", "=", "localResolver", ".", "getClusterEndpoints", "(", ")", ";", "if", "(", "result", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "remoteResolver", ".", "getClusterEndpoints", "(", ")", ";", "}", "return", "result", ";", "}", "}", ";", "List", "<", "AwsEndpoint", ">", "initialValue", "=", "compoundResolver", ".", "getClusterEndpoints", "(", ")", ";", "String", "[", "]", "availZones", "=", "clientConfig", ".", "getAvailabilityZones", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ";", "String", "myZone", "=", "InstanceInfo", ".", "getZone", "(", "availZones", ",", "myInstanceInfo", ")", ";", "return", "new", "AsyncResolver", "<", ">", "(", "EurekaClientNames", ".", "BOOTSTRAP", ",", "new", "ZoneAffinityClusterResolver", "(", "compoundResolver", ",", "myZone", ",", "true", ")", ",", "initialValue", ",", "transportConfig", ".", "getAsyncExecutorThreadPoolSize", "(", ")", ",", "transportConfig", ".", "getAsyncResolverRefreshIntervalMs", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testCompositeBootstrapResolver", "(", ")", "throws", "Exception", "{", "Applications", "applications", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:5>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "Applications", "applications2", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:2>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "String", "vipAddress", "=", "applications", ".", "getRegisteredApplications", "(", "\"", "<STR_LIT>", "\"", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "when", "(", "clientConfig", ".", "shouldUseDnsForFetchingServiceUrls", "(", ")", ")", ".", "thenReturn", "(", "false", ")", ";", "when", "(", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "anyString", "(", ")", ")", ")", ".", "thenReturn", "(", "Arrays", ".", "asList", "(", "\"", "<STR_LIT>", "\"", ")", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "transportConfig", ".", "getWriteClusterVip", "(", ")", ")", ".", "thenReturn", "(", "vipAddress", ")", ";", "when", "(", "transportConfig", ".", "getAsyncExecutorThreadPoolSize", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT:3>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverRefreshIntervalMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverWarmUpTimeoutMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", "=", "mock", "(", "ApplicationsResolver", ".", "ApplicationsSource", ".", "class", ")", ";", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "null", ")", ".", "thenReturn", "(", "applications", ")", ".", "thenReturn", "(", "null", ")", ";", "EurekaHttpClient", "mockHttpClient", "=", "mock", "(", "EurekaHttpClient", ".", "class", ")", ";", "when", "(", "mockHttpClient", ".", "getVip", "(", "eq", "(", "vipAddress", ")", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications", ")", ".", "build", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications2", ")", ".", "build", "(", ")", ")", ";", "TransportClientFactory", "transportClientFactory", "=", "mock", "(", "TransportClientFactory", ".", "class", ")", ";", "when", "(", "transportClientFactory", ".", "newClient", "(", "any", "(", "EurekaEndpoint", ".", "class", ")", ")", ")", ".", "thenReturn", "(", "mockHttpClient", ")", ";", "ClosableResolver", "<", "AwsEndpoint", ">", "resolver", "=", "EurekaHttpClients", ".", "compositeBootstrapResolver", "(", "clientConfig", ",", "transportConfig", ",", "transportClientFactory", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "List", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "applicationsSource", ",", "timeout", "(", "<NUM_LIT:1000>", ")", ".", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "applicationsSource", ",", "timeout", "(", "<NUM_LIT:1000>", ")", ".", "times", "(", "<NUM_LIT:3>", ")", ")", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications2", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "if", "(", "redirectServerMockClient", "!", "=", "null", ")", "{", "redirectServerMockClient", ".", "reset", "(", ")", ";", "redirectServerMockClient", ".", "stop", "(", ")", ";", "}", "if", "(", "targetServerMockClient", ".", "client", "!", "=", "null", ")", "{", "targetServerMockClient", ".", "client", ".", "reset", "(", ")", ";", "targetServerMockClient", ".", "client", ".", "stop", "(", ")", ";", "}", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "if", "(", "serverMockClient", "!", "=", "null", ")", "{", "serverMockClient", ".", "reset", "(", ")", ";", "serverMockClient", ".", "stop", "(", ")", ";", "}", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testCompositeBootstrapResolver", "(", ")", "throws", "Exception", "{", "Applications", "applications", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:5>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "Applications", "applications2", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:2>", ",", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ".", "toApplications", "(", ")", ";", "String", "vipAddress", "=", "applications", ".", "getRegisteredApplications", "(", "\"", "<STR_LIT>", "\"", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ".", "getVIPAddress", "(", ")", ";", "when", "(", "clientConfig", ".", "shouldUseDnsForFetchingServiceUrls", "(", ")", ")", ".", "thenReturn", "(", "false", ")", ";", "when", "(", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "anyString", "(", ")", ")", ")", ".", "thenReturn", "(", "Arrays", ".", "asList", "(", "\"", "<STR_LIT>", "\"", ")", ")", ";", "when", "(", "clientConfig", ".", "getRegion", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "transportConfig", ".", "getWriteClusterVip", "(", ")", ")", ".", "thenReturn", "(", "vipAddress", ")", ";", "when", "(", "transportConfig", ".", "getAsyncExecutorThreadPoolSize", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT:4>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverRefreshIntervalMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "when", "(", "transportConfig", ".", "getAsyncResolverWarmUpTimeoutMs", "(", ")", ")", ".", "thenReturn", "(", "<NUM_LIT>", ")", ";", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", "=", "mock", "(", "ApplicationsResolver", ".", "ApplicationsSource", ".", "class", ")", ";", "when", "(", "applicationsSource", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ")", ".", "thenReturn", "(", "null", ")", ".", "thenReturn", "(", "applications", ")", ".", "thenReturn", "(", "null", ")", ";", "EurekaHttpClient", "mockHttpClient", "=", "mock", "(", "EurekaHttpClient", ".", "class", ")", ";", "when", "(", "mockHttpClient", ".", "getVip", "(", "eq", "(", "vipAddress", ")", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications", ")", ".", "build", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "applications2", ")", ".", "build", "(", ")", ")", ";", "TransportClientFactory", "transportClientFactory", "=", "mock", "(", "TransportClientFactory", ".", "class", ")", ";", "when", "(", "transportClientFactory", ".", "newClient", "(", "any", "(", "EurekaEndpoint", ".", "class", ")", ")", ")", ".", "thenReturn", "(", "mockHttpClient", ")", ";", "ClosableResolver", "<", "AwsEndpoint", ">", "resolver", "=", "null", ";", "try", "{", "resolver", "=", "EurekaHttpClients", ".", "compositeBootstrapResolver", "(", "clientConfig", ",", "transportConfig", ",", "transportClientFactory", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "List", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "applicationsSource", ",", "timeout", "(", "<NUM_LIT>", ")", ".", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "getApplications", "(", "anyInt", "(", ")", ",", "eq", "(", "TimeUnit", ".", "SECONDS", ")", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "verify", "(", "mockHttpClient", ",", "timeout", "(", "<NUM_LIT>", ")", ".", "times", "(", "<NUM_LIT:3>", ")", ")", ".", "getVip", "(", "anyString", "(", ")", ")", ";", "endpoints", "=", "resolver", ".", "getClusterEndpoints", "(", ")", ";", "assertThat", "(", "endpoints", ".", "size", "(", ")", ",", "equalTo", "(", "applications2", ".", "getInstancesByVirtualHostName", "(", "vipAddress", ")", ".", "size", "(", ")", ")", ")", ";", "}", "finally", "{", "if", "(", "resolver", "!", "=", "null", ")", "{", "resolver", ".", "shutdown", "(", ")", ";", "}", "}", "}", "</s>"]
["<s>", "public", "String", "toString", "(", ")", "{", "return", "getName", "(", ")", ";", "}", "</s>"]
["<s>", "private", "static", "boolean", "isBlank", "(", "String", "str", ")", "{", "return", "str", "=", "=", "null", "|", "|", "str", ".", "isEmpty", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAmazonInfoNoUpdateIfEqual", "(", ")", "{", "AmazonInfo", "oldInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "newInfo", "=", "copyAmazonInfo", "(", "instanceInfo", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAmazonInfoNoUpdateIfEmpty", "(", ")", "{", "AmazonInfo", "oldInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "newInfo", "=", "new", "AmazonInfo", "(", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAmazonInfoNoUpdateIfNoLocalIpv4", "(", ")", "{", "AmazonInfo", "oldInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "newInfo", "=", "copyAmazonInfo", "(", "instanceInfo", ")", ";", "newInfo", ".", "getMetadata", "(", ")", ".", "remove", "(", "localIpv4", ".", "getName", "(", ")", ")", ";", "assertThat", "(", "newInfo", ".", "get", "(", "localIpv4", ")", ",", "is", "(", "nullValue", "(", ")", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "newInfo", ".", "getMetadata", "(", ")", ".", "put", "(", "localIpv4", ".", "getName", "(", ")", ",", "\"", "\"", ")", ";", "assertThat", "(", "newInfo", ".", "get", "(", "localIpv4", ")", ",", "is", "(", "\"", "\"", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "false", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAmazonInfoUpdatePositiveCase", "(", ")", "{", "AmazonInfo", "oldInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "newInfo", "=", "copyAmazonInfo", "(", "instanceInfo", ")", ";", "newInfo", ".", "getMetadata", "(", ")", ".", "remove", "(", "amiId", ".", "getName", "(", ")", ")", ";", "assertThat", "(", "newInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ",", "is", "(", "oldInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", "-", "1", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "true", ")", ")", ";", "String", "newKey", "=", "\"", "<STR_LIT>", "\"", ";", "newInfo", ".", "getMetadata", "(", ")", ".", "put", "(", "newKey", ",", "\"", "<STR_LIT>", "\"", ")", ";", "assertThat", "(", "newInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ",", "is", "(", "oldInfo", ".", "getMetadata", "(", ")", ".", "size", "(", ")", ")", ")", ";", "assertThat", "(", "CloudInstanceConfig", ".", "shouldUpdate", "(", "newInfo", ",", "oldInfo", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "private", "static", "AmazonInfo", "copyAmazonInfo", "(", "InstanceInfo", "instanceInfo", ")", "{", "AmazonInfo", "currInfo", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "AmazonInfo", "copyInfo", "=", "new", "AmazonInfo", "(", ")", ";", "for", "(", "String", "key", ":", "currInfo", ".", "getMetadata", "(", ")", ".", "keySet", "(", ")", ")", "{", "copyInfo", ".", "getMetadata", "(", ")", ".", "put", "(", "key", ",", "currInfo", ".", "getMetadata", "(", ")", ".", "get", "(", "key", ")", ")", ";", "}", "return", "copyInfo", ";", "}", "</s>"]
["<s>", "@", "Inject", "(", "optional", "=", "true", ")", "public", "void", "setEventListeners", "(", "Set", "<", "EurekaEventListener", ">", "listeners", ")", "{", "if", "(", "eventListeners", "=", "=", "null", ")", "{", "eventListeners", "=", "new", "HashSet", "<", ">", "(", ")", ";", "}", "eventListeners", ".", "addAll", "(", "listeners", ")", ";", "}", "</s>"]
["<s>", "Set", "<", "EurekaEventListener", ">", "getEventListeners", "(", ")", "{", "return", "eventListeners", "=", "=", "null", "?", "Collections", ".", "emptySet", "(", ")", ":", "eventListeners", ";", "}", "</s>"]
["<s>", "@", "VisibleForTesting", "void", "refreshRegistry", "(", ")", "{", "try", "{", "boolean", "isFetchingRemoteRegionRegistries", "=", "isFetchingRemoteRegionRegistries", "(", ")", ";", "boolean", "remoteRegionsModified", "=", "false", ";", "String", "latestRemoteRegions", "=", "clientConfig", ".", "fetchRegistryForRemoteRegions", "(", ")", ";", "if", "(", "null", "!", "=", "latestRemoteRegions", ")", "{", "String", "currentRemoteRegions", "=", "remoteRegionsToFetch", ".", "get", "(", ")", ";", "if", "(", "!", "latestRemoteRegions", ".", "equals", "(", "currentRemoteRegions", ")", ")", "{", "synchronized", "(", "instanceRegionChecker", ".", "getAzToRegionMapper", "(", ")", ")", "{", "if", "(", "remoteRegionsToFetch", ".", "compareAndSet", "(", "currentRemoteRegions", ",", "latestRemoteRegions", ")", ")", "{", "String", "[", "]", "remoteRegions", "=", "latestRemoteRegions", ".", "split", "(", "\"", "<STR_LIT:U+002C>", "\"", ")", ";", "remoteRegionsRef", ".", "set", "(", "remoteRegions", ")", ";", "instanceRegionChecker", ".", "getAzToRegionMapper", "(", ")", ".", "setRegionsToFetch", "(", "remoteRegions", ")", ";", "remoteRegionsModified", "=", "true", ";", "}", "else", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", "+", "\"", "<STR_LIT>", "\"", ",", "currentRemoteRegions", ",", "latestRemoteRegions", ")", ";", "}", "}", "}", "else", "{", "instanceRegionChecker", ".", "getAzToRegionMapper", "(", ")", ".", "refreshMapping", "(", ")", ";", "}", "}", "boolean", "success", "=", "fetchRegistry", "(", "remoteRegionsModified", ")", ";", "if", "(", "success", ")", "{", "registrySize", "=", "localRegionApps", ".", "get", "(", ")", ".", "size", "(", ")", ";", "lastSuccessfulRegistryFetchTimestamp", "=", "System", ".", "currentTimeMillis", "(", ")", ";", "}", "if", "(", "logger", ".", "isDebugEnabled", "(", ")", ")", "{", "StringBuilder", "allAppsHashCodes", "=", "new", "StringBuilder", "(", ")", ";", "allAppsHashCodes", ".", "append", "(", "\"", "<STR_LIT>", "\"", ")", ";", "allAppsHashCodes", ".", "append", "(", "localRegionApps", ".", "get", "(", ")", ".", "getAppsHashCode", "(", ")", ")", ";", "allAppsHashCodes", ".", "append", "(", "\"", "<STR_LIT>", "\"", ")", ";", "allAppsHashCodes", ".", "append", "(", "isFetchingRemoteRegionRegistries", ")", ";", "for", "(", "Map", ".", "Entry", "<", "String", ",", "Applications", ">", "entry", ":", "remoteRegionVsApps", ".", "entrySet", "(", ")", ")", "{", "allAppsHashCodes", ".", "append", "(", "\"", "<STR_LIT>", "\"", ")", ";", "allAppsHashCodes", ".", "append", "(", "entry", ".", "getKey", "(", ")", ")", ";", "allAppsHashCodes", ".", "append", "(", "\"", "<STR_LIT>", "\"", ")", ";", "allAppsHashCodes", ".", "append", "(", "entry", ".", "getValue", "(", ")", ".", "getAppsHashCode", "(", ")", ")", ";", "}", "logger", ".", "debug", "(", "\"", "<STR_LIT>", "\"", ",", "allAppsHashCodes", ".", "toString", "(", ")", ")", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "}", "</s>"]
["<s>", "protected", "void", "fireEvent", "(", "final", "EurekaEvent", "event", ")", "{", "for", "(", "EurekaEventListener", "listener", ":", "eventListeners", ")", "{", "listener", ".", "onEvent", "(", "event", ")", ";", "}", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "reset", "(", "requestHandler", ")", ";", "when", "(", "requestHandler", ".", "register", "(", "any", "(", "InstanceInfo", ".", "class", ")", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "status", "(", "<NUM_LIT>", ")", ")", ";", "when", "(", "requestHandler", ".", "cancel", "(", "anyString", "(", ")", ",", "anyString", "(", ")", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "status", "(", "<NUM_LIT>", ")", ")", ";", "when", "(", "requestHandler", ".", "getDelta", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "new", "Applications", "(", ")", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testCacheRefreshEvent", "(", ")", "throws", "Exception", "{", "CapturingEurekaEventListener", "listener", "=", "new", "CapturingEurekaEventListener", "(", ")", ";", "Applications", "initialApps", "=", "toApplications", "(", "discoveryClientResource", ".", "getMyInstanceInfo", "(", ")", ")", ";", "when", "(", "requestHandler", ".", "getApplications", "(", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "initialApps", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "DiscoveryClient", "client", "=", "(", "DiscoveryClient", ")", "discoveryClientResource", ".", "getClient", "(", ")", ";", "client", ".", "registerEventListener", "(", "listener", ")", ";", "client", ".", "refreshRegistry", "(", ")", ";", "assertNotNull", "(", "listener", ".", "event", ")", ";", "assertThat", "(", "listener", ".", "event", ",", "is", "(", "instanceOf", "(", "CacheRefreshedEvent", ".", "class", ")", ")", ")", ";", "}", "</s>"]
["<s>", "private", "void", "scheduleServerEndpointTask", "(", "EurekaTransport", "eurekaTransport", ",", "DiscoveryClientOptionalArgs", "args", ")", "{", "Collection", "<", "ClientFilter", ">", "additionalFilters", "=", "args", "=", "=", "null", "?", "Collections", ".", "<", "ClientFilter", ">", "emptyList", "(", ")", ":", "args", ".", "additionalFilters", ";", "EurekaJerseyClient", "providedJerseyClient", "=", "args", "=", "=", "null", "?", "null", ":", "args", ".", "eurekaJerseyClient", ";", "eurekaTransport", ".", "transportClientFactory", "=", "providedJerseyClient", "=", "=", "null", "?", "TransportClientFactories", ".", "newTransportClientFactory", "(", "clientConfig", ",", "additionalFilters", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ":", "TransportClientFactories", ".", "newTransportClientFactory", "(", "additionalFilters", ",", "providedJerseyClient", ")", ";", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", "=", "new", "ApplicationsResolver", ".", "ApplicationsSource", "(", ")", "{", "@", "Override", "public", "Applications", "getApplications", "(", "int", "stalenessThreshold", ",", "TimeUnit", "timeUnit", ")", "{", "long", "thresholdInMs", "=", "TimeUnit", ".", "MILLISECONDS", ".", "convert", "(", "stalenessThreshold", ",", "timeUnit", ")", ";", "long", "delay", "=", "getLastSuccessfulRegistryFetchTimePeriod", "(", ")", ";", "if", "(", "delay", ">", "thresholdInMs", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "thresholdInMs", ",", "delay", ")", ";", "return", "null", ";", "}", "else", "{", "return", "localRegionApps", ".", "get", "(", ")", ";", "}", "}", "}", ";", "eurekaTransport", ".", "bootstrapResolver", "=", "EurekaHttpClients", ".", "newBootstrapResolver", "(", "clientConfig", ",", "transportConfig", ",", "eurekaTransport", ".", "transportClientFactory", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "if", "(", "clientConfig", ".", "shouldRegisterWithEureka", "(", ")", ")", "{", "EurekaHttpClientFactory", "newRegistrationClientFactory", "=", "null", ";", "EurekaHttpClient", "newRegistrationClient", "=", "null", ";", "try", "{", "newRegistrationClientFactory", "=", "EurekaHttpClients", ".", "registrationClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "transportConfig", ")", ";", "newRegistrationClient", "=", "newRegistrationClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "registrationClientFactory", "=", "newRegistrationClientFactory", ";", "eurekaTransport", ".", "registrationClient", "=", "newRegistrationClient", ";", "}", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "EurekaHttpClientFactory", "newQueryClientFactory", "=", "null", ";", "EurekaHttpClient", "newQueryClient", "=", "null", ";", "try", "{", "newQueryClientFactory", "=", "EurekaHttpClients", ".", "queryClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "clientConfig", ",", "transportConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "newQueryClient", "=", "newQueryClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "queryClientFactory", "=", "newQueryClientFactory", ";", "eurekaTransport", ".", "queryClient", "=", "newQueryClient", ";", "}", "}", "</s>"]
["<s>", "protected", "void", "addExtraProperties", "(", "Builder", "webResource", ")", "{", "if", "(", "userName", "!", "=", "null", ")", "{", "webResource", ".", "property", "(", "HttpAuthenticationFeature", ".", "HTTP_AUTHENTICATION_USERNAME", ",", "userName", ")", ".", "property", "(", "HttpAuthenticationFeature", ".", "HTTP_AUTHENTICATION_PASSWORD", ",", "password", ")", ";", "}", "}", "</s>"]
["<s>", "public", "Jersey2ApplicationClientFactoryBuilder", "withFeature", "(", "Feature", "feature", ")", "{", "features", ".", "add", "(", "feature", ")", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "DiscoveryClientRuleBuilder", "basicAuthentication", "(", "String", "userName", ",", "String", "password", ")", "{", "Preconditions", ".", "checkNotNull", "(", "userName", ",", "\"", "<STR_LIT>", "\"", ")", ";", "Preconditions", ".", "checkNotNull", "(", "password", ",", "\"", "<STR_LIT>", "\"", ")", ";", "this", ".", "userName", "=", "userName", ";", "this", ".", "password", "=", "password", ";", "return", "this", ";", "}", "</s>"]
["<s>", "protected", "EurekaHttpClient", "getEurekaClientWithBasicAuthentication", "(", "String", "userName", ",", "String", "password", ")", "{", "URI", "serviceURI", "=", "UriBuilder", ".", "fromUri", "(", "getHttpServer", "(", ")", ".", "getServiceURI", "(", ")", ")", ".", "userInfo", "(", "userName", "+", "<CHAR_LIT::>", "+", "password", ")", ".", "build", "(", ")", ";", "return", "getEurekaHttpClient", "(", "serviceURI", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testBasicAuthentication", "(", ")", "throws", "Exception", "{", "InstanceInfo", "instance", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "when", "(", "requestHandler", ".", "register", "(", "instance", ")", ")", ".", "thenReturn", "(", "EurekaHttpResponse", ".", "status", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "httpResponse", "=", "getEurekaClientWithBasicAuthentication", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "register", "(", "instance", ")", ";", "assertThat", "(", "httpResponse", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "assertThat", "(", "observedHttpRequests", ".", "get", "(", "0", ")", ".", "getHeaders", "(", ")", ".", "containsKey", "(", "HttpHeaders", ".", "AUTHORIZATION", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "public", "String", "getRequestMethod", "(", ")", "{", "return", "requestMethod", ";", "}", "</s>"]
["<s>", "public", "URI", "getRequestURI", "(", ")", "{", "return", "requestURI", ";", "}", "</s>"]
["<s>", "public", "Map", "<", "String", ",", "String", ">", "getHeaders", "(", ")", "{", "return", "headers", ";", "}", "</s>"]
["<s>", "private", "EurekaHttpRequest", "mapToEurekaHttpRequest", "(", "HttpExchange", "httpExchange", ")", "{", "Headers", "exchangeHeaders", "=", "httpExchange", ".", "getRequestHeaders", "(", ")", ";", "Map", "<", "String", ",", "String", ">", "headers", "=", "new", "HashMap", "<", ">", "(", ")", ";", "for", "(", "String", "key", ":", "exchangeHeaders", ".", "keySet", "(", ")", ")", "{", "headers", ".", "put", "(", "key", ",", "exchangeHeaders", ".", "getFirst", "(", "key", ")", ")", ";", "}", "return", "new", "EurekaHttpRequest", "(", "httpExchange", ".", "getRequestMethod", "(", ")", ",", "httpExchange", ".", "getRequestURI", "(", ")", ",", "headers", ")", ";", "}", "</s>"]
["<s>", "public", "EurekaInstanceConfig", "getEurekaInstanceConfig", "(", ")", "{", "return", "config", ";", "}", "</s>"]
["<s>", "public", "EurekaClientConfig", "getEurekaClientConfig", "(", ")", "{", "return", "clientConfig", ";", "}", "</s>"]
["<s>", "public", "static", "String", "getPrivateIp", "(", "InstanceInfo", "instanceInfo", ")", "{", "String", "defaultPrivateIp", "=", "null", ";", "if", "(", "instanceInfo", ".", "getDataCenterInfo", "(", ")", "instanceof", "AmazonInfo", ")", "{", "defaultPrivateIp", "=", "(", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "localIpv4", ")", ";", "}", "if", "(", "defaultPrivateIp", "=", "=", "null", ")", "{", "defaultPrivateIp", "=", "instanceInfo", ".", "getIPAddr", "(", ")", ";", "}", "return", "defaultPrivateIp", ";", "}", "</s>"]
["<s>", "public", "static", "boolean", "isInEc2", "(", "InstanceInfo", "instanceInfo", ")", "{", "if", "(", "instanceInfo", ".", "getDataCenterInfo", "(", ")", "instanceof", "AmazonInfo", ")", "{", "String", "instanceId", "=", "(", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "getId", "(", ")", ";", "if", "(", "instanceId", "!", "=", "null", "&", "&", "instanceId", ".", "startsWith", "(", "\"", "<STR_LIT:->", "\"", ")", ")", "{", "return", "true", ";", "}", "}", "return", "false", ";", "}", "</s>"]
["<s>", "public", "static", "boolean", "isInVpc", "(", "InstanceInfo", "instanceInfo", ")", "{", "if", "(", "instanceInfo", ".", "getDataCenterInfo", "(", ")", "instanceof", "AmazonInfo", ")", "{", "AmazonInfo", "info", "=", "(", "AmazonInfo", ")", "instanceInfo", ".", "getDataCenterInfo", "(", ")", ";", "String", "vpcId", "=", "info", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "vpcId", ")", ";", "return", "!", "isNullOrEmpty", "(", "vpcId", ")", ";", "}", "return", "false", ";", "}", "</s>"]
["<s>", "private", "static", "boolean", "isNullOrEmpty", "(", "String", "str", ")", "{", "return", "str", "=", "=", "null", "|", "|", "str", ".", "isEmpty", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testIsInEc2", "(", ")", "{", "InstanceInfo", "instanceInfo1", "=", "new", "InstanceInfo", ".", "Builder", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ".", "setDataCenterInfo", "(", "new", "DataCenterInfo", "(", ")", "{", "@", "Override", "public", "Name", "getName", "(", ")", "{", "return", "Name", ".", "MyOwn", ";", "}", "}", ")", ".", "build", "(", ")", ";", "Assert", ".", "assertFalse", "(", "EurekaUtils", ".", "isInEc2", "(", "instanceInfo1", ")", ")", ";", "InstanceInfo", "instanceInfo2", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "Assert", ".", "assertTrue", "(", "EurekaUtils", ".", "isInEc2", "(", "instanceInfo2", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testIsInVpc", "(", ")", "{", "InstanceInfo", "instanceInfo1", "=", "new", "InstanceInfo", ".", "Builder", "(", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ")", ".", "setDataCenterInfo", "(", "new", "DataCenterInfo", "(", ")", "{", "@", "Override", "public", "Name", "getName", "(", ")", "{", "return", "Name", ".", "MyOwn", ";", "}", "}", ")", ".", "build", "(", ")", ";", "Assert", ".", "assertFalse", "(", "EurekaUtils", ".", "isInVpc", "(", "instanceInfo1", ")", ")", ";", "InstanceInfo", "instanceInfo2", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "Assert", ".", "assertFalse", "(", "EurekaUtils", ".", "isInVpc", "(", "instanceInfo2", ")", ")", ";", "InstanceInfo", "instanceInfo3", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "(", "(", "AmazonInfo", ")", "instanceInfo3", ".", "getDataCenterInfo", "(", ")", ")", ".", "getMetadata", "(", ")", ".", "put", "(", "AmazonInfo", ".", "MetaDataKey", ".", "vpcId", ".", "getName", "(", ")", ",", "\"", "<STR_LIT>", "\"", ")", ";", "Assert", ".", "assertTrue", "(", "EurekaUtils", ".", "isInVpc", "(", "instanceInfo3", ")", ")", ";", "}", "</s>"]
["<s>", "@", "PostConstruct", "public", "void", "start", "(", ")", "throws", "Exception", "{", "int", "retries", "=", "serverConfig", ".", "getEIPBindRebindRetries", "(", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "retries", ";", "i", "+", "+", ")", "{", "try", "{", "if", "(", "alreadyBound", "(", ")", ")", "{", "break", ";", "}", "else", "{", "bind", "(", ")", ";", "}", "}", "catch", "(", "Throwable", "e", ")", "{", "logger", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "Thread", ".", "sleep", "(", "IP_BIND_SLEEP_TIME_MS", ")", ";", "}", "}", "timer", ".", "schedule", "(", "new", "IPBindingTask", "(", ")", ",", "serverConfig", ".", "getEIPBindingRetryIntervalMsWhenUnbound", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "PreDestroy", "public", "void", "shutdown", "(", ")", "throws", "Exception", "{", "timer", ".", "cancel", "(", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "serverConfig", ".", "getEIPBindRebindRetries", "(", ")", ";", "i", "+", "+", ")", "{", "try", "{", "unbind", "(", ")", ";", "break", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "Thread", ".", "sleep", "(", "IP_BIND_SLEEP_TIME_MS", ")", ";", "}", "}", "}", "</s>"]
["<s>", "public", "boolean", "alreadyBound", "(", ")", "throws", "MalformedURLException", "{", "InstanceInfo", "myInfo", "=", "applicationInfoManager", ".", "getInfo", "(", ")", ";", "String", "myInstanceId", "=", "(", "(", "AmazonInfo", ")", "myInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ")", ";", "AmazonEC2", "ec2Service", "=", "getEC2Service", "(", ")", ";", "List", "<", "InstanceNetworkInterface", ">", "instanceNetworkInterfaces", "=", "instanceData", "(", "myInstanceId", ",", "ec2Service", ")", ".", "getNetworkInterfaces", "(", ")", ";", "List", "<", "String", ">", "candidateIPs", "=", "getCandidateIps", "(", ")", ";", "for", "(", "String", "ip", ":", "candidateIPs", ")", "{", "for", "(", "InstanceNetworkInterface", "ini", ":", "instanceNetworkInterfaces", ")", "{", "if", "(", "ip", ".", "equals", "(", "ini", ".", "getPrivateIpAddress", "(", ")", ")", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "myInstanceId", ",", "ip", ")", ";", "return", "true", ";", "}", "}", "}", "return", "false", ";", "}", "</s>"]
["<s>", "public", "void", "bind", "(", ")", "throws", "MalformedURLException", "{", "InstanceInfo", "myInfo", "=", "ApplicationInfoManager", ".", "getInstance", "(", ")", ".", "getInfo", "(", ")", ";", "String", "myInstanceId", "=", "(", "(", "AmazonInfo", ")", "myInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ")", ";", "String", "myZone", "=", "(", "(", "AmazonInfo", ")", "myInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "availabilityZone", ")", ";", "List", "<", "String", ">", "ips", "=", "getCandidateIps", "(", ")", ";", "AmazonEC2", "ec2Service", "=", "getEC2Service", "(", ")", ";", "DescribeNetworkInterfacesResult", "result", "=", "ec2Service", ".", "describeNetworkInterfaces", "(", "new", "DescribeNetworkInterfacesRequest", "(", ")", ".", "withFilters", "(", "new", "Filter", "(", "\"", "<STR_LIT>", "\"", ",", "ips", ")", ")", ".", "withFilters", "(", "new", "Filter", "(", "\"", "<STR_LIT>", "\"", ",", "Lists", ".", "newArrayList", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", ".", "withFilters", "(", "new", "Filter", "(", "\"", "<STR_LIT>", "\"", ",", "Lists", ".", "newArrayList", "(", "myZone", ")", ")", ")", ")", ";", "if", "(", "result", ".", "getNetworkInterfaces", "(", ")", ".", "isEmpty", "(", ")", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "ips", ",", "myZone", ")", ";", "}", "else", "{", "NetworkInterface", "selected", "=", "result", ".", "getNetworkInterfaces", "(", ")", ".", "get", "(", "0", ")", ";", "ec2Service", ".", "attachNetworkInterface", "(", "new", "AttachNetworkInterfaceRequest", "(", ")", ".", "withNetworkInterfaceId", "(", "selected", ".", "getNetworkInterfaceId", "(", ")", ")", ".", "withDeviceIndex", "(", "1", ")", ".", "withInstanceId", "(", "myInstanceId", ")", ")", ";", "}", "}", "</s>"]
["<s>", "public", "void", "unbind", "(", ")", "throws", "Exception", "{", "InstanceInfo", "myInfo", "=", "applicationInfoManager", ".", "getInfo", "(", ")", ";", "String", "myInstanceId", "=", "(", "(", "AmazonInfo", ")", "myInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ")", ";", "AmazonEC2", "ec2", "=", "getEC2Service", "(", ")", ";", "List", "<", "InstanceNetworkInterface", ">", "result", "=", "instanceData", "(", "myInstanceId", ",", "ec2", ")", ".", "getNetworkInterfaces", "(", ")", ";", "List", "<", "String", ">", "ips", "=", "getCandidateIps", "(", ")", ";", "for", "(", "InstanceNetworkInterface", "networkInterface", ":", "result", ")", "{", "if", "(", "ips", ".", "contains", "(", "networkInterface", ".", "getPrivateIpAddress", "(", ")", ")", ")", "{", "String", "attachmentId", "=", "networkInterface", ".", "getAttachment", "(", ")", ".", "getAttachmentId", "(", ")", ";", "ec2", ".", "detachNetworkInterface", "(", "new", "DetachNetworkInterfaceRequest", "(", ")", ".", "withAttachmentId", "(", "attachmentId", ")", ")", ";", "break", ";", "}", "}", "}", "</s>"]
["<s>", "private", "Instance", "instanceData", "(", "String", "myInstanceId", ",", "AmazonEC2", "ec2", ")", "{", "return", "ec2", ".", "describeInstances", "(", "new", "DescribeInstancesRequest", "(", ")", ".", "withInstanceIds", "(", "myInstanceId", ")", ")", ".", "getReservations", "(", ")", ".", "get", "(", "0", ")", ".", "getInstances", "(", ")", ".", "get", "(", "0", ")", ";", "}", "</s>"]
["<s>", "public", "List", "<", "String", ">", "getCandidateIps", "(", ")", "throws", "MalformedURLException", "{", "InstanceInfo", "myInfo", "=", "applicationInfoManager", ".", "getInfo", "(", ")", ";", "String", "myZone", "=", "(", "(", "AmazonInfo", ")", "myInfo", ".", "getDataCenterInfo", "(", ")", ")", ".", "get", "(", "AmazonInfo", ".", "MetaDataKey", ".", "availabilityZone", ")", ";", "Collection", "<", "String", ">", "candidates", "=", "clientConfig", ".", "shouldUseDnsForFetchingServiceUrls", "(", ")", "?", "getIPsForZoneFromDNS", "(", "myZone", ")", ":", "getIPsForZoneFromConfig", "(", "myZone", ")", ";", "if", "(", "candidates", "=", "=", "null", "|", "|", "candidates", ".", "size", "(", ")", "=", "=", "0", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "<STR_LIT>", "\"", "+", "myZone", ")", ";", "}", "List", "<", "String", ">", "ips", "=", "Lists", ".", "newArrayList", "(", ")", ";", "for", "(", "String", "candidate", ":", "candidates", ")", "{", "String", "host", "=", "new", "URL", "(", "candidate", ")", ".", "getHost", "(", ")", ";", "if", "(", "IPAddressUtil", ".", "isIPv4LiteralAddress", "(", "host", ")", ")", "{", "ips", ".", "add", "(", "host", ")", ";", "}", "else", "{", "String", "firstPartOfHost", "=", "Splitter", ".", "on", "(", "\"", "<STR_LIT:.>", "\"", ")", ".", "splitToList", "(", "host", ")", ".", "get", "(", "0", ")", ";", "List", "<", "String", ">", "noIpPrefix", "=", "Splitter", ".", "on", "(", "\"", "<STR_LIT:->", "\"", ")", ".", "splitToList", "(", "firstPartOfHost", ")", ".", "subList", "(", "1", ",", "<NUM_LIT:5>", ")", ";", "String", "ip", "=", "Joiner", ".", "on", "(", "\"", "<STR_LIT:.>", "\"", ")", ".", "join", "(", "noIpPrefix", ")", ";", "if", "(", "IPAddressUtil", ".", "isIPv4LiteralAddress", "(", "ip", ")", ")", "{", "ips", ".", "add", "(", "ip", ")", ";", "}", "else", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "<STR_LIT>", "\"", "+", "host", "+", "\"", "<STR_LIT>", "\"", "+", "ip", "+", "\"", "'", "\"", ")", ";", "}", "}", "}", "return", "ips", ";", "}", "</s>"]
["<s>", "private", "Collection", "<", "String", ">", "getIPsForZoneFromConfig", "(", "String", "myZone", ")", "{", "return", "clientConfig", ".", "getEurekaServerServiceUrls", "(", "myZone", ")", ";", "}", "</s>"]
["<s>", "private", "Collection", "<", "String", ">", "getIPsForZoneFromDNS", "(", "String", "myZone", ")", "{", "return", "EndpointUtils", ".", "getServiceUrlsFromDNS", "(", "clientConfig", ",", "myZone", ",", "true", ",", "new", "EndpointUtils", ".", "InstanceInfoBasedUrlRandomizer", "(", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "private", "AmazonEC2", "getEC2Service", "(", ")", "{", "String", "aWSAccessId", "=", "serverConfig", ".", "getAWSAccessId", "(", ")", ";", "String", "aWSSecretKey", "=", "serverConfig", ".", "getAWSSecretKey", "(", ")", ";", "AmazonEC2", "ec2Service", ";", "if", "(", "null", "!", "=", "aWSAccessId", "&", "&", "!", "\"", "\"", ".", "equals", "(", "aWSAccessId", ")", "&", "&", "null", "!", "=", "aWSSecretKey", "&", "&", "!", "\"", "\"", ".", "equals", "(", "aWSSecretKey", ")", ")", "{", "ec2Service", "=", "new", "AmazonEC2Client", "(", "new", "BasicAWSCredentials", "(", "aWSAccessId", ",", "aWSSecretKey", ")", ")", ";", "}", "else", "{", "ec2Service", "=", "new", "AmazonEC2Client", "(", "new", "InstanceProfileCredentialsProvider", "(", ")", ")", ";", "}", "String", "region", "=", "clientConfig", ".", "getRegion", "(", ")", ";", "region", "=", "region", ".", "trim", "(", ")", ".", "toLowerCase", "(", ")", ";", "ec2Service", ".", "setEndpoint", "(", "\"", "<STR_LIT>", "\"", "+", "region", "+", "\"", "<STR_LIT>", "\"", ")", ";", "return", "ec2Service", ";", "}", "</s>"]
["<s>", "public", "Integer", "apply", "(", "NetworkInterface", "networkInterface", ")", "{", "return", "ips", ".", "indexOf", "(", "networkInterface", ".", "getPrivateIpAddress", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testApplyDeltaWithBadInstanceInfoDataCenterInfoAsNull", "(", ")", "throws", "Exception", "{", "InstanceInfoGenerator", "instanceGen", "=", "InstanceInfoGenerator", ".", "newBuilder", "(", "<NUM_LIT:2>", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ";", "InstanceInfo", "first", "=", "instanceGen", ".", "first", "(", ")", ";", "Applications", "initial", "=", "toApplications", "(", "first", ")", ";", "when", "(", "requestHandler", ".", "getApplications", "(", "TEST_REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "initial", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "EurekaClient", "client", "=", "discoveryClientResource", ".", "getClient", "(", ")", ";", "assertThat", "(", "client", ".", "getApplications", "(", ")", ".", "getAppsHashCode", "(", ")", ",", "is", "(", "equalTo", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", ";", "InstanceInfo", "second", "=", "new", "InstanceInfo", ".", "Builder", "(", "instanceGen", ".", "take", "(", "1", ")", ")", ".", "setStatus", "(", "InstanceStatus", ".", "DOWN", ")", ".", "setDataCenterInfo", "(", "null", ")", ".", "build", "(", ")", ";", "Applications", "delta", "=", "toApplications", "(", "second", ")", ";", "delta", ".", "setAppsHashCode", "(", "\"", "<STR_LIT>", "\"", ")", ";", "when", "(", "requestHandler", ".", "getDelta", "(", "TEST_REMOTE_REGION", ")", ")", ".", "thenReturn", "(", "anEurekaHttpResponse", "(", "<NUM_LIT>", ",", "delta", ")", ".", "type", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "build", "(", ")", ")", ";", "assertThat", "(", "discoveryClientResource", ".", "awaitCacheUpdate", "(", "<NUM_LIT:5>", ",", "TimeUnit", ".", "SECONDS", ")", ",", "is", "(", "true", ")", ")", ";", "assertThat", "(", "client", ".", "getApplications", "(", ")", ".", "getAppsHashCode", "(", ")", ",", "is", "(", "equalTo", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", ";", "}", "</s>"]
["<s>", "public", "AmazonInfo", "autoBuild", "(", "String", "namespace", ",", "boolean", "failFast", ")", "{", "initProperties", "(", "namespace", ")", ";", "int", "failFastRetryCount", "=", "awsMetaDataFailFastRetries", ".", "get", "(", ")", ";", "for", "(", "MetaDataKey", "key", ":", "MetaDataKey", ".", "values", "(", ")", ")", "{", "if", "(", "failFastRetryCount", "<", "=", "0", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "awsMetaDataFailFastRetries", ".", "get", "(", ")", ")", ";", "break", ";", "}", "int", "numOfRetries", "=", "awsMetaDataRetries", ".", "get", "(", ")", ";", "while", "(", "numOfRetries", "-", "-", ">", "0", ")", "{", "try", "{", "String", "mac", "=", "null", ";", "if", "(", "key", "=", "=", "MetaDataKey", ".", "vpcId", ")", "{", "mac", "=", "result", ".", "metadata", ".", "get", "(", "MetaDataKey", ".", "mac", ".", "getName", "(", ")", ")", ";", "}", "URL", "url", "=", "key", ".", "getURL", "(", "null", ",", "mac", ")", ";", "HttpURLConnection", "uc", "=", "(", "HttpURLConnection", ")", "url", ".", "openConnection", "(", ")", ";", "uc", ".", "setConnectTimeout", "(", "awsMetaDataConnectTimeout", ".", "get", "(", ")", ")", ";", "uc", ".", "setReadTimeout", "(", "awsMetaDataReadTimeout", ".", "get", "(", ")", ")", ";", "if", "(", "uc", ".", "getResponseCode", "(", ")", "!", "=", "HttpURLConnection", ".", "HTTP_OK", ")", "{", "BufferedReader", "br", "=", "new", "BufferedReader", "(", "new", "InputStreamReader", "(", "uc", ".", "getErrorStream", "(", ")", ")", ")", ";", "try", "{", "while", "(", "br", ".", "readLine", "(", ")", "!", "=", "null", ")", "{", "}", "}", "finally", "{", "br", ".", "close", "(", ")", ";", "}", "}", "else", "{", "String", "value", "=", "key", ".", "read", "(", "uc", ".", "getInputStream", "(", ")", ")", ";", "if", "(", "value", "!", "=", "null", ")", "{", "result", ".", "metadata", ".", "put", "(", "key", ".", "getName", "(", ")", ",", "value", ")", ";", "}", "}", "break", ";", "}", "catch", "(", "Throwable", "e", ")", "{", "if", "(", "failFast", "&", "&", "key", "=", "=", "MetaDataKey", ".", "instanceId", ")", "{", "failFastRetryCount", "-", "-", ";", "}", "if", "(", "shouldLogAWSMetadataError", ".", "get", "(", ")", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", "+", "key", "+", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "if", "(", "numOfRetries", ">", "=", "0", ")", "{", "try", "{", "Thread", ".", "sleep", "(", "SLEEP_TIME_MS", ")", ";", "}", "catch", "(", "InterruptedException", "e1", ")", "{", "}", "continue", ";", "}", "}", "}", "}", "return", "result", ";", "}", "</s>"]
["<s>", "public", "String", "resolveDefaultAddress", "(", "boolean", "refresh", ")", "{", "String", "result", "=", "getHostName", "(", "refresh", ")", ";", "for", "(", "String", "name", ":", "getDefaultAddressResolutionOrder", "(", ")", ")", "{", "try", "{", "AmazonInfo", ".", "MetaDataKey", "key", "=", "AmazonInfo", ".", "MetaDataKey", ".", "valueOf", "(", "name", ")", ";", "String", "address", "=", "info", ".", "get", "(", "key", ")", ";", "if", "(", "address", "!", "=", "null", "&", "&", "!", "address", ".", "isEmpty", "(", ")", ")", "{", "result", "=", "address", ";", "break", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "name", ",", "e", ")", ";", "}", "}", "return", "result", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testOnDemandUpdateResetAutomaticRefreshWithInitialDelay", "(", ")", "throws", "Throwable", "{", "replicator", ".", "start", "(", "<NUM_LIT:1000>", "*", "refreshRateSeconds", ")", ";", "assertTrue", "(", "replicator", ".", "onDemandUpdate", "(", ")", ")", ";", "Thread", ".", "sleep", "(", "<NUM_LIT:1000>", "*", "refreshRateSeconds", "+", "<NUM_LIT:100>", ")", ";", "verify", "(", "discoveryClient", ",", "times", "(", "<NUM_LIT:2>", ")", ")", ".", "refreshInstanceInfo", "(", ")", ";", "verify", "(", "discoveryClient", ",", "times", "(", "1", ")", ")", ".", "register", "(", ")", ";", "}", "</s>"]
["<s>", "private", "static", "synchronized", "ApplicationInfoManager", "initializeApplicationInfoManager", "(", "EurekaInstanceConfig", "instanceConfig", ")", "{", "if", "(", "applicationInfoManager", "=", "=", "null", ")", "{", "applicationInfoManager", "=", "new", "ApplicationInfoManager", "(", "instanceConfig", ")", ";", "}", "return", "applicationInfoManager", ";", "}", "</s>"]
["<s>", "private", "static", "synchronized", "EurekaClient", "initializeEurekaClient", "(", "ApplicationInfoManager", "applicationInfoManager", ",", "EurekaClientConfig", "clientConfig", ")", "{", "if", "(", "eurekaClient", "=", "=", "null", ")", "{", "eurekaClient", "=", "new", "DiscoveryClient", "(", "applicationInfoManager", ",", "clientConfig", ")", ";", "}", "return", "eurekaClient", ";", "}", "</s>"]
["<s>", "private", "static", "synchronized", "ApplicationInfoManager", "initializeApplicationInfoManager", "(", "EurekaInstanceConfig", "instanceConfig", ")", "{", "if", "(", "applicationInfoManager", "=", "=", "null", ")", "{", "InstanceInfo", "instanceInfo", "=", "new", "EurekaConfigBasedInstanceInfoProvider", "(", "instanceConfig", ")", ".", "get", "(", ")", ";", "applicationInfoManager", "=", "new", "ApplicationInfoManager", "(", "instanceConfig", ",", "instanceInfo", ")", ";", "}", "return", "applicationInfoManager", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckCallbackGuiceProvider", "(", ")", "{", "DiscoveryClientOptionalArgs", "args", "=", "new", "DiscoveryClientOptionalArgs", "(", ")", ";", "args", ".", "setHealthCheckCallbackProvider", "(", "new", "GuiceProvider", "<", "HealthCheckCallback", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckCallbackJavaxProvider", "(", ")", "{", "DiscoveryClientOptionalArgs", "args", "=", "new", "DiscoveryClientOptionalArgs", "(", ")", ";", "args", ".", "setHealthCheckCallbackProvider", "(", "new", "JavaxProvider", "<", "HealthCheckCallback", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckHandlerGuiceProvider", "(", ")", "{", "DiscoveryClientOptionalArgs", "args", "=", "new", "DiscoveryClientOptionalArgs", "(", ")", ";", "args", ".", "setHealthCheckHandlerProvider", "(", "new", "GuiceProvider", "<", "HealthCheckHandler", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckHandlerJavaxProvider", "(", ")", "{", "DiscoveryClientOptionalArgs", "args", "=", "new", "DiscoveryClientOptionalArgs", "(", ")", ";", "args", ".", "setHealthCheckHandlerProvider", "(", "new", "JavaxProvider", "<", "HealthCheckHandler", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "public", "synchronized", "void", "start", "(", ")", "{", "if", "(", "!", "isActive", ")", "{", "timer", ".", "schedule", "(", "new", "TimerTask", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "try", "{", "lastBucket", ".", "set", "(", "currentBucket", ".", "getAndSet", "(", "0", ")", ")", ";", "}", "catch", "(", "Throwable", "e", ")", "{", "logger", ".", "error", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "}", "}", ",", "sampleInterval", ",", "sampleInterval", ")", ";", "isActive", "=", "true", ";", "}", "}", "</s>"]
["<s>", "public", "synchronized", "void", "stop", "(", ")", "{", "if", "(", "isActive", ")", "{", "timer", ".", "cancel", "(", ")", ";", "isActive", "=", "false", ";", "}", "}", "</s>"]
["<s>", "public", "boolean", "isThisMyUrl", "(", "String", "url", ")", "{", "InstanceInfo", "myInfo", "=", "applicationInfoManager", ".", "getInfo", "(", ")", ";", "String", "hostName", "=", "hostFromUrl", "(", "url", ")", ";", "return", "hostName", "!", "=", "null", "&", "&", "hostName", ".", "equals", "(", "myInfo", ".", "getHostName", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "InstanceInfo", "seed", "=", "InstanceInfoGenerator", ".", "takeOne", "(", ")", ";", "id", "=", "seed", ".", "getId", "(", ")", ";", "appName", "=", "seed", ".", "getAppName", "(", ")", ";", "instance1", "=", "InstanceInfo", ".", "Builder", ".", "newBuilder", "(", ")", ".", "setInstanceId", "(", "id", ")", ".", "setAppName", "(", "appName", ")", ".", "setHostName", "(", "seed", ".", "getHostName", "(", ")", ")", ".", "setIPAddr", "(", "seed", ".", "getIPAddr", "(", ")", ")", ".", "setDataCenterInfo", "(", "seed", ".", "getDataCenterInfo", "(", ")", ")", ".", "setStatus", "(", "InstanceInfo", ".", "InstanceStatus", ".", "STARTING", ")", ".", "setLastDirtyTimestamp", "(", "<NUM_LIT>", ")", ".", "build", "(", ")", ";", "instance2", "=", "new", "InstanceInfo", ".", "Builder", "(", "seed", ")", ".", "setInstanceId", "(", "id", ")", ".", "setAppName", "(", "appName", ")", ".", "setHostName", "(", "seed", ".", "getHostName", "(", ")", ")", ".", "setIPAddr", "(", "seed", ".", "getIPAddr", "(", ")", ")", ".", "setDataCenterInfo", "(", "seed", ".", "getDataCenterInfo", "(", ")", ")", ".", "setStatus", "(", "InstanceInfo", ".", "InstanceStatus", ".", "UP", ")", ".", "setLastDirtyTimestamp", "(", "<NUM_LIT>", ")", ".", "build", "(", ")", ";", "assertThat", "(", "instance1", ".", "getStatus", "(", ")", ",", "not", "(", "equalTo", "(", "instance2", ".", "getStatus", "(", ")", ")", ")", ")", ";", "PeerEurekaNodes", "server1Peers", "=", "Mockito", ".", "mock", "(", "PeerEurekaNodes", ".", "class", ")", ";", "Mockito", ".", "when", "(", "server1Peers", ".", "getPeerEurekaNodes", "(", ")", ")", ".", "thenReturn", "(", "Collections", ".", "<", "PeerEurekaNode", ">", "emptyList", "(", ")", ")", ";", "server1", "=", "new", "MockServer", "(", "appName", ",", "server1Peers", ")", ";", "PeerEurekaNodes", "server2Peers", "=", "Mockito", ".", "mock", "(", "PeerEurekaNodes", ".", "class", ")", ";", "Mockito", ".", "when", "(", "server2Peers", ".", "getPeerEurekaNodes", "(", ")", ")", ".", "thenReturn", "(", "Collections", ".", "<", "PeerEurekaNode", ">", "emptyList", "(", ")", ")", ";", "server2", "=", "new", "MockServer", "(", "appName", ",", "server2Peers", ")", ";", "server1", ".", "applicationResource", ".", "addInstance", "(", "instance1", ",", "\"", "<STR_LIT>", "\"", ")", ";", "server1Sees", "=", "server1", ".", "registry", ".", "getInstanceByAppAndId", "(", "appName", ",", "id", ")", ";", "assertThat", "(", "server1Sees", ",", "equalTo", "(", "instance1", ")", ")", ";", "server2", ".", "applicationResource", ".", "addInstance", "(", "instance2", ",", "\"", "<STR_LIT>", "\"", ")", ";", "server2Sees", "=", "server2", ".", "registry", ".", "getInstanceByAppAndId", "(", "appName", ",", "id", ")", ";", "assertThat", "(", "server2Sees", ",", "equalTo", "(", "instance2", ")", ")", ";", "assertThat", "(", "server2Sees", ".", "getLastDirtyTimestamp", "(", ")", ">", "server1Sees", ".", "getLastDirtyTimestamp", "(", ")", ",", "is", "(", "true", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testReplicationWithRegistrationAndUpdateOnDifferentServers", "(", ")", "throws", "Exception", "{", "server2", ".", "applicationResource", ".", "addInstance", "(", "instance1", ",", "\"", "<STR_LIT>", "\"", ")", ";", "InstanceInfo", "newServer2Sees", "=", "server2", ".", "registry", ".", "getInstanceByAppAndId", "(", "appName", ",", "id", ")", ";", "assertThat", "(", "newServer2Sees", ".", "getStatus", "(", ")", ",", "equalTo", "(", "instance2", ".", "getStatus", "(", ")", ")", ")", ";", "server1", ".", "applicationResource", ".", "addInstance", "(", "newServer2Sees", ",", "\"", "<STR_LIT>", "\"", ")", ";", "InstanceInfo", "newServer1Sees", "=", "server1", ".", "registry", ".", "getInstanceByAppAndId", "(", "appName", ",", "id", ")", ";", "assertThat", "(", "newServer1Sees", ".", "getStatus", "(", ")", ",", "equalTo", "(", "instance2", ".", "getStatus", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "protected", "static", "InstanceInfo", "createLocalStartingInstance", "(", "String", "hostname", ")", "{", "return", "createLocalInstanceWithStatus", "(", "hostname", ",", "InstanceInfo", ".", "InstanceStatus", ".", "STARTING", ")", ";", "}", "</s>"]
["<s>", "protected", "static", "InstanceInfo", "createLocalOutOfServiceInstance", "(", "String", "hostname", ")", "{", "return", "createLocalInstanceWithStatus", "(", "hostname", ",", "InstanceInfo", ".", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "}", "</s>"]
["<s>", "private", "static", "InstanceInfo", "createLocalInstanceWithStatus", "(", "String", "hostname", ",", "InstanceInfo", ".", "InstanceStatus", "status", ")", "{", "InstanceInfo", ".", "Builder", "instanceBuilder", "=", "InstanceInfo", ".", "Builder", ".", "newBuilder", "(", ")", ";", "instanceBuilder", ".", "setAppName", "(", "LOCAL_REGION_APP_NAME", ")", ";", "instanceBuilder", ".", "setHostName", "(", "hostname", ")", ";", "instanceBuilder", ".", "setIPAddr", "(", "\"", "<STR_LIT>", "\"", ")", ";", "instanceBuilder", ".", "setDataCenterInfo", "(", "getAmazonInfo", "(", "null", ",", "hostname", ")", ")", ";", "instanceBuilder", ".", "setLeaseInfo", "(", "LeaseInfo", ".", "Builder", ".", "newBuilder", "(", ")", ".", "build", "(", ")", ")", ";", "instanceBuilder", ".", "setStatus", "(", "status", ")", ";", "return", "instanceBuilder", ".", "build", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testStatusOverrideStartingStatus", "(", ")", "throws", "Exception", "{", "InstanceInfo", "myInstance", "=", "createLocalInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "UP", ")", ";", "boolean", "statusResult", "=", "registry", ".", "statusUpdate", "(", "LOCAL_REGION_APP_NAME", ",", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ",", "\"", "<STR_LIT:0>", "\"", ",", "false", ")", ";", "assertThat", "(", "\"", "<STR_LIT>", "\"", ",", "statusResult", ",", "is", "(", "true", ")", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "myInstance", "=", "createLocalStartingInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "STARTING", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testStatusOverrideWithExistingLeaseUp", "(", ")", "throws", "Exception", "{", "InstanceInfo", "myInstance", "=", "createLocalInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "UP", ")", ";", "InstanceInfo", "sameInstance", "=", "createLocalOutOfServiceInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registry", ".", "register", "(", "sameInstance", ",", "<NUM_LIT>", ",", "false", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "UP", ")", ";", "sameInstance", "=", "createLocalOutOfServiceInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registry", ".", "register", "(", "sameInstance", ",", "<NUM_LIT>", ",", "false", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "UP", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testStatusOverrideWithExistingLeaseOutOfService", "(", ")", "throws", "Exception", "{", "InstanceInfo", "myInstance", "=", "createLocalOutOfServiceInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "InstanceInfo", "sameInstance", "=", "createLocalInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registry", ".", "register", "(", "sameInstance", ",", "<NUM_LIT>", ",", "false", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "sameInstance", "=", "createLocalInstance", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registry", ".", "register", "(", "sameInstance", ",", "<NUM_LIT>", ",", "false", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "}", "</s>"]
["<s>", "public", "static", "StatusOverrideResult", "matchingStatus", "(", "InstanceInfo", ".", "InstanceStatus", "status", ")", "{", "return", "new", "StatusOverrideResult", "(", "true", ",", "status", ")", ";", "}", "</s>"]
["<s>", "public", "boolean", "matches", "(", ")", "{", "return", "matches", ";", "}", "</s>"]
["<s>", "public", "InstanceInfo", ".", "InstanceStatus", "status", "(", ")", "{", "return", "status", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testDefaultAsgStatus", "(", ")", "{", "Assert", ".", "assertEquals", "(", "true", ",", "awsAsgUtil", ".", "isASGEnabled", "(", "instanceInfo", ")", ")", ";", "}", "</s>"]
["<s>", "protected", "DataCenterInfo", "getDataCenterInfo", "(", ")", "{", "return", "new", "DataCenterInfo", "(", ")", "{", "@", "Override", "public", "Name", "getName", "(", ")", "{", "return", "Name", ".", "MyOwn", ";", "}", "}", ";", "}", "</s>"]
["<s>", "protected", "PeerAwareInstanceRegistryImpl", "makePeerAwareInstanceRegistry", "(", "EurekaServerConfig", "serverConfig", ",", "EurekaClientConfig", "clientConfig", ",", "ServerCodecs", "serverCodecs", ",", "EurekaClient", "eurekaClient", ")", "{", "return", "new", "TestPeerAwareInstanceRegistry", "(", "serverConfig", ",", "clientConfig", ",", "serverCodecs", ",", "eurekaClient", ")", ";", "}", "</s>"]
["<s>", "protected", "void", "verifyLocalInstanceStatus", "(", "String", "id", ",", "InstanceInfo", ".", "InstanceStatus", "status", ")", "{", "InstanceInfo", "instanceInfo", "=", "registry", ".", "getApplication", "(", "LOCAL_REGION_APP_NAME", ")", ".", "getByInstanceId", "(", "id", ")", ";", "assertThat", "(", "\"", "<STR_LIT>", "\"", "+", "id", "+", "\"", "<STR_LIT>", "\"", ",", "instanceInfo", ",", "is", "(", "notNullValue", "(", ")", ")", ")", ";", "assertThat", "(", "\"", "<STR_LIT>", "\"", ",", "instanceInfo", ".", "getStatus", "(", ")", ",", "is", "(", "equalTo", "(", "status", ")", ")", ")", ";", "}", "</s>"]
["<s>", "protected", "void", "registerInstanceLocally", "(", "InstanceInfo", "remoteInstance", ")", "{", "registry", ".", "register", "(", "remoteInstance", ",", "<NUM_LIT>", ",", "false", ")", ";", "registeredApps", ".", "add", "(", "new", "Pair", "<", "String", ",", "String", ">", "(", "LOCAL_REGION_APP_NAME", ",", "LOCAL_REGION_APP_NAME", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testOverridesWithAsgEnabledThenDisabled", "(", ")", "{", "InstanceInfo", "myInstance", "=", "createLocalUpInstanceWithAsg", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "UP", ")", ";", "(", "(", "AwsInstanceRegistry", ")", "registry", ")", ".", "getAwsAsgUtil", "(", ")", ".", "setStatus", "(", "\"", "<STR_LIT>", "\"", ",", "false", ")", ";", "myInstance", "=", "createLocalUpInstanceWithAsg", "(", "LOCAL_REGION_INSTANCE_1_HOSTNAME", ")", ";", "registerInstanceLocally", "(", "myInstance", ")", ";", "verifyLocalInstanceStatus", "(", "myInstance", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "OUT_OF_SERVICE", ")", ";", "}", "</s>"]
["<s>", "private", "static", "InstanceInfo", "createLocalUpInstanceWithAsg", "(", "String", "hostname", ")", "{", "InstanceInfo", ".", "Builder", "instanceBuilder", "=", "InstanceInfo", ".", "Builder", ".", "newBuilder", "(", ")", ";", "instanceBuilder", ".", "setAppName", "(", "LOCAL_REGION_APP_NAME", ")", ";", "instanceBuilder", ".", "setHostName", "(", "hostname", ")", ";", "instanceBuilder", ".", "setIPAddr", "(", "\"", "<STR_LIT>", "\"", ")", ";", "instanceBuilder", ".", "setDataCenterInfo", "(", "getAmazonInfo", "(", "hostname", ")", ")", ";", "instanceBuilder", ".", "setLeaseInfo", "(", "LeaseInfo", ".", "Builder", ".", "newBuilder", "(", ")", ".", "build", "(", ")", ")", ";", "instanceBuilder", ".", "setStatus", "(", "InstanceStatus", ".", "UP", ")", ";", "instanceBuilder", ".", "setASGName", "(", "\"", "<STR_LIT>", "\"", ")", ";", "return", "instanceBuilder", ".", "build", "(", ")", ";", "}", "</s>"]
["<s>", "private", "static", "AmazonInfo", "getAmazonInfo", "(", "String", "instanceHostName", ")", "{", "AmazonInfo", ".", "Builder", "azBuilder", "=", "AmazonInfo", ".", "Builder", ".", "newBuilder", "(", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "availabilityZone", ",", "\"", "<STR_LIT>", "\"", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceId", ",", "instanceHostName", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "amiId", ",", "\"", "<STR_LIT>", "\"", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "instanceType", ",", "\"", "<STR_LIT>", "\"", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "localIpv4", ",", "\"", "<STR_LIT>", "\"", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "publicIpv4", ",", "\"", "<STR_LIT>", "\"", ")", ";", "azBuilder", ".", "addMetadata", "(", "AmazonInfo", ".", "MetaDataKey", ".", "publicHostname", ",", "instanceHostName", ")", ";", "return", "azBuilder", ".", "build", "(", ")", ";", "}", "</s>"]
["<s>", "private", "EurekaHttpResponse", "<", "Applications", ">", "getApplicationsInternal", "(", "String", "urlPath", ",", "String", "[", "]", "regions", ")", "{", "Response", "response", "=", "null", ";", "String", "regionsParamValue", "=", "null", ";", "try", "{", "WebTarget", "webTarget", "=", "jerseyClient", ".", "getClient", "(", ")", ".", "target", "(", "serviceUrl", ")", ".", "path", "(", "urlPath", ")", ";", "if", "(", "regions", "!", "=", "null", "&", "&", "regions", ".", "length", ">", "0", ")", "{", "webTarget", "=", "webTarget", ".", "queryParam", "(", "\"", "<STR_LIT>", "\"", ",", "StringUtil", ".", "join", "(", "regions", ")", ")", ";", "}", "Builder", "requestBuilder", "=", "webTarget", ".", "request", "(", ")", ";", "addExtraProperties", "(", "requestBuilder", ")", ";", "addExtraHeaders", "(", "requestBuilder", ")", ";", "response", "=", "requestBuilder", ".", "accept", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "get", "(", ")", ";", "Applications", "applications", "=", "null", ";", "if", "(", "response", ".", "getStatus", "(", ")", "=", "=", "Status", ".", "OK", ".", "getStatusCode", "(", ")", "&", "&", "response", ".", "hasEntity", "(", ")", ")", "{", "applications", "=", "response", ".", "readEntity", "(", "Applications", ".", "class", ")", ";", "}", "return", "anEurekaHttpResponse", "(", "response", ".", "getStatus", "(", ")", ",", "applications", ")", ".", "headers", "(", "headersOf", "(", "response", ")", ")", ".", "build", "(", ")", ";", "}", "finally", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", ")", ")", "{", "logger", ".", "debug", "(", "\"", "<STR_LIT>", "\"", ",", "serviceUrl", ",", "urlPath", ",", "response", "=", "=", "null", "?", "\"", "<STR_LIT>", "\"", ":", "response", ".", "getStatus", "(", ")", ")", ";", "}", "if", "(", "response", "!", "=", "null", ")", "{", "response", ".", "close", "(", ")", ";", "}", "}", "}", "</s>"]
["<s>", "private", "EurekaHttpResponse", "<", "InstanceInfo", ">", "getInstanceInternal", "(", "String", "urlPath", ")", "{", "Response", "response", "=", "null", ";", "try", "{", "Builder", "requestBuilder", "=", "jerseyClient", ".", "getClient", "(", ")", ".", "target", "(", "serviceUrl", ")", ".", "path", "(", "urlPath", ")", ".", "request", "(", ")", ";", "addExtraProperties", "(", "requestBuilder", ")", ";", "addExtraHeaders", "(", "requestBuilder", ")", ";", "response", "=", "requestBuilder", ".", "accept", "(", "MediaType", ".", "APPLICATION_JSON_TYPE", ")", ".", "get", "(", ")", ";", "InstanceInfo", "infoFromPeer", "=", "null", ";", "if", "(", "response", ".", "getStatus", "(", ")", "=", "=", "Status", ".", "OK", ".", "getStatusCode", "(", ")", "&", "&", "response", ".", "hasEntity", "(", ")", ")", "{", "infoFromPeer", "=", "response", ".", "readEntity", "(", "InstanceInfo", ".", "class", ")", ";", "}", "return", "anEurekaHttpResponse", "(", "response", ".", "getStatus", "(", ")", ",", "infoFromPeer", ")", ".", "headers", "(", "headersOf", "(", "response", ")", ")", ".", "build", "(", ")", ";", "}", "finally", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", ")", ")", "{", "logger", ".", "debug", "(", "\"", "<STR_LIT>", "\"", ",", "serviceUrl", ",", "urlPath", ",", "response", "=", "=", "null", "?", "\"", "<STR_LIT>", "\"", ":", "response", ".", "getStatus", "(", ")", ")", ";", "}", "if", "(", "response", "!", "=", "null", ")", "{", "response", ".", "close", "(", ")", ";", "}", "}", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withClientName", "(", "String", "clientName", ")", "{", "this", ".", "clientName", "=", "clientName", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withUserAgent", "(", "String", "userAgent", ")", "{", "this", ".", "userAgent", "=", "userAgent", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withConnectionTimeout", "(", "int", "connectionTimeout", ")", "{", "this", ".", "connectionTimeout", "=", "connectionTimeout", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withReadTimeout", "(", "int", "readTimeout", ")", "{", "this", ".", "readTimeout", "=", "readTimeout", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withConnectionIdleTimeout", "(", "int", "connectionIdleTimeout", ")", "{", "this", ".", "connectionIdleTimeout", "=", "connectionIdleTimeout", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withMaxConnectionsPerHost", "(", "int", "maxConnectionsPerHost", ")", "{", "this", ".", "maxConnectionsPerHost", "=", "maxConnectionsPerHost", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withMaxTotalConnections", "(", "int", "maxTotalConnections", ")", "{", "this", ".", "maxTotalConnections", "=", "maxTotalConnections", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withProxy", "(", "String", "proxyHost", ",", "String", "proxyPort", ",", "String", "user", ",", "String", "password", ")", "{", "this", ".", "proxyHost", "=", "proxyHost", ";", "this", ".", "proxyPort", "=", "proxyPort", ";", "this", ".", "proxyUserName", "=", "user", ";", "this", ".", "proxyPassword", "=", "password", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withSystemSSLConfiguration", "(", ")", "{", "this", ".", "systemSSL", "=", "true", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withTrustStoreFile", "(", "String", "trustStoreFileName", ",", "String", "trustStorePassword", ")", "{", "this", ".", "trustStoreFileName", "=", "trustStoreFileName", ";", "this", ".", "trustStorePassword", "=", "trustStorePassword", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withEncoder", "(", "String", "encoderName", ")", "{", "return", "this", ".", "withEncoderWrapper", "(", "CodecWrappers", ".", "getEncoder", "(", "encoderName", ")", ")", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withEncoderWrapper", "(", "EncoderWrapper", "encoderWrapper", ")", "{", "this", ".", "encoderWrapper", "=", "encoderWrapper", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withDecoder", "(", "String", "decoderName", ",", "String", "clientDataAccept", ")", "{", "return", "this", ".", "withDecoderWrapper", "(", "CodecWrappers", ".", "resolveDecoder", "(", "decoderName", ",", "clientDataAccept", ")", ")", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2ClientBuilder", "withDecoderWrapper", "(", "DecoderWrapper", "decoderWrapper", ")", "{", "this", ".", "decoderWrapper", "=", "decoderWrapper", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "EurekaJersey2Client", "build", "(", ")", "{", "MyDefaultApacheHttpClient4Config", "config", "=", "new", "MyDefaultApacheHttpClient4Config", "(", ")", ";", "try", "{", "return", "new", "EurekaJersey2ClientImpl", "(", "connectionTimeout", ",", "readTimeout", ",", "connectionIdleTimeout", ",", "config", ")", ";", "}", "catch", "(", "Throwable", "e", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "}", "</s>"]
["<s>", "private", "void", "addProxyConfiguration", "(", ")", "{", "if", "(", "proxyUserName", "!", "=", "null", "&", "&", "proxyPassword", "!", "=", "null", ")", "{", "property", "(", "ClientProperties", ".", "PROXY_USERNAME", ",", "proxyUserName", ")", ";", "property", "(", "ClientProperties", ".", "PROXY_PASSWORD", ",", "proxyPassword", ")", ";", "}", "else", "{", "property", "(", "ClientProperties", ".", "PROXY_USERNAME", ",", "\"", "<STR_LIT>", "\"", ")", ";", "property", "(", "ClientProperties", ".", "PROXY_PASSWORD", ",", "\"", "<STR_LIT>", "\"", ")", ";", "}", "property", "(", "ClientProperties", ".", "PROXY_URI", ",", "\"", "<STR_LIT>", "\"", "+", "proxyHost", "+", "\"", "<STR_LIT::>", "\"", "+", "proxyPort", ")", ";", "}", "</s>"]
["<s>", "private", "PoolingHttpClientConnectionManager", "createSystemSslCM", "(", ")", "{", "ConnectionSocketFactory", "socketFactory", "=", "SSLConnectionSocketFactory", ".", "getSystemSocketFactory", "(", ")", ";", "Registry", "registry", "=", "RegistryBuilder", ".", "<", "ConnectionSocketFactory", ">", "create", "(", ")", ".", "register", "(", "PROTOCOL", ",", "socketFactory", ")", ".", "build", "(", ")", ";", "return", "new", "PoolingHttpClientConnectionManager", "(", "registry", ")", ";", "}", "</s>"]
["<s>", "private", "PoolingHttpClientConnectionManager", "createCustomSslCM", "(", ")", "{", "FileInputStream", "fin", "=", "null", ";", "try", "{", "SSLContext", "sslContext", "=", "SSLContext", ".", "getInstance", "(", "PROTOCOL_SCHEME", ")", ";", "KeyStore", "sslKeyStore", "=", "KeyStore", ".", "getInstance", "(", "KEYSTORE_TYPE", ")", ";", "fin", "=", "new", "FileInputStream", "(", "trustStoreFileName", ")", ";", "sslKeyStore", ".", "load", "(", "fin", ",", "trustStorePassword", ".", "toCharArray", "(", ")", ")", ";", "TrustManagerFactory", "factory", "=", "TrustManagerFactory", ".", "getInstance", "(", "TrustManagerFactory", ".", "getDefaultAlgorithm", "(", ")", ")", ";", "factory", ".", "init", "(", "sslKeyStore", ")", ";", "TrustManager", "[", "]", "trustManagers", "=", "factory", ".", "getTrustManagers", "(", ")", ";", "sslContext", ".", "init", "(", "null", ",", "trustManagers", ",", "null", ")", ";", "ConnectionSocketFactory", "socketFactory", "=", "new", "SSLConnectionSocketFactory", "(", "sslContext", ",", "SSLConnectionSocketFactory", ".", "ALLOW_ALL_HOSTNAME_VERIFIER", ")", ";", "Registry", "registry", "=", "RegistryBuilder", ".", "<", "ConnectionSocketFactory", ">", "create", "(", ")", ".", "register", "(", "PROTOCOL", ",", "socketFactory", ")", ".", "build", "(", ")", ";", "return", "new", "PoolingHttpClientConnectionManager", "(", "registry", ")", ";", "}", "catch", "(", "Exception", "ex", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "<STR_LIT>", "\"", ",", "ex", ")", ";", "}", "finally", "{", "if", "(", "fin", "!", "=", "null", ")", "{", "try", "{", "fin", ".", "close", "(", ")", ";", "}", "catch", "(", "IOException", "ignore", ")", "{", "}", "}", "}", "}", "</s>"]
["<s>", "public", "static", "Jersey2ApplicationClientFactory", "create", "(", "EurekaClientConfig", "clientConfig", ",", "Collection", "<", "ClientRequestFilter", ">", "additionalFilters", ",", "InstanceInfo", "myInstanceInfo", ",", "AbstractEurekaIdentity", "clientIdentity", ")", "{", "Jersey2ApplicationClientFactoryBuilder", "clientBuilder", "=", "newBuilder", "(", ")", ";", "clientBuilder", ".", "withAdditionalFilters", "(", "additionalFilters", ")", ";", "clientBuilder", ".", "withMyInstanceInfo", "(", "myInstanceInfo", ")", ";", "clientBuilder", ".", "withUserAgent", "(", "\"", "<STR_LIT>", "\"", ")", ";", "clientBuilder", ".", "withClientConfig", "(", "clientConfig", ")", ";", "clientBuilder", ".", "withClientIdentity", "(", "clientIdentity", ")", ";", "if", "(", "\"", "<STR_LIT>", "\"", ".", "equals", "(", "System", ".", "getProperty", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withSystemSSLConfiguration", "(", ")", ";", "}", "else", "if", "(", "clientConfig", ".", "getProxyHost", "(", ")", "!", "=", "null", "&", "&", "clientConfig", ".", "getProxyPort", "(", ")", "!", "=", "null", ")", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withProxy", "(", "clientConfig", ".", "getProxyHost", "(", ")", ",", "Integer", ".", "parseInt", "(", "clientConfig", ".", "getProxyPort", "(", ")", ")", ",", "clientConfig", ".", "getProxyUserName", "(", ")", ",", "clientConfig", ".", "getProxyPassword", "(", ")", ")", ";", "}", "else", "{", "clientBuilder", ".", "withClientName", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "return", "clientBuilder", ".", "build", "(", ")", ";", "}", "</s>"]
["<s>", "Jersey2ApplicationClientFactoryBuilder", "withAdditionalFilters", "(", "Collection", "<", "ClientRequestFilter", ">", "additionalFilters", ")", "{", "if", "(", "additionalFilters", "!", "=", "null", ")", "{", "this", ".", "additionalFilters", ".", "addAll", "(", "additionalFilters", ")", ";", "}", "return", "this", ";", "}", "</s>"]
["<s>", "public", "static", "Jersey2TransportClientFactories", "getInstance", "(", ")", "{", "return", "INSTANCE", ";", "}", "</s>"]
["<s>", "private", "void", "scheduleServerEndpointTask", "(", "EurekaTransport", "eurekaTransport", ",", "AbstractDiscoveryClientOptionalArgs", "args", ")", "{", "Collection", "<", "?", ">", "additionalFilters", "=", "args", "=", "=", "null", "?", "Collections", ".", "emptyList", "(", ")", ":", "args", ".", "additionalFilters", ";", "EurekaJerseyClient", "providedJerseyClient", "=", "args", "=", "=", "null", "?", "null", ":", "args", ".", "eurekaJerseyClient", ";", "TransportClientFactories", "transportClientFactories", "=", "TransportClientFactories", ".", "INSTANCE", ";", "if", "(", "args", "!", "=", "null", "&", "&", "args", ".", "getTransportClientFactories", "(", ")", "!", "=", "null", ")", "{", "transportClientFactories", "=", "args", ".", "getTransportClientFactories", "(", ")", ";", "}", "eurekaTransport", ".", "transportClientFactory", "=", "providedJerseyClient", "=", "=", "null", "?", "transportClientFactories", ".", "newTransportClientFactory", "(", "clientConfig", ",", "(", "Collection", "<", "ClientFilter", ">", ")", "additionalFilters", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ")", ":", "transportClientFactories", ".", "newTransportClientFactory", "(", "(", "Collection", "<", "ClientFilter", ">", ")", "additionalFilters", ",", "providedJerseyClient", ")", ";", "ApplicationsResolver", ".", "ApplicationsSource", "applicationsSource", "=", "new", "ApplicationsResolver", ".", "ApplicationsSource", "(", ")", "{", "@", "Override", "public", "Applications", "getApplications", "(", "int", "stalenessThreshold", ",", "TimeUnit", "timeUnit", ")", "{", "long", "thresholdInMs", "=", "TimeUnit", ".", "MILLISECONDS", ".", "convert", "(", "stalenessThreshold", ",", "timeUnit", ")", ";", "long", "delay", "=", "getLastSuccessfulRegistryFetchTimePeriod", "(", ")", ";", "if", "(", "delay", ">", "thresholdInMs", ")", "{", "logger", ".", "info", "(", "\"", "<STR_LIT>", "\"", ",", "thresholdInMs", ",", "delay", ")", ";", "return", "null", ";", "}", "else", "{", "return", "localRegionApps", ".", "get", "(", ")", ";", "}", "}", "}", ";", "eurekaTransport", ".", "bootstrapResolver", "=", "EurekaHttpClients", ".", "newBootstrapResolver", "(", "clientConfig", ",", "transportConfig", ",", "eurekaTransport", ".", "transportClientFactory", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "if", "(", "clientConfig", ".", "shouldRegisterWithEureka", "(", ")", ")", "{", "EurekaHttpClientFactory", "newRegistrationClientFactory", "=", "null", ";", "EurekaHttpClient", "newRegistrationClient", "=", "null", ";", "try", "{", "newRegistrationClientFactory", "=", "EurekaHttpClients", ".", "registrationClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "transportConfig", ")", ";", "newRegistrationClient", "=", "newRegistrationClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "registrationClientFactory", "=", "newRegistrationClientFactory", ";", "eurekaTransport", ".", "registrationClient", "=", "newRegistrationClient", ";", "}", "if", "(", "clientConfig", ".", "shouldFetchRegistry", "(", ")", ")", "{", "EurekaHttpClientFactory", "newQueryClientFactory", "=", "null", ";", "EurekaHttpClient", "newQueryClient", "=", "null", ";", "try", "{", "newQueryClientFactory", "=", "EurekaHttpClients", ".", "queryClientFactory", "(", "eurekaTransport", ".", "bootstrapResolver", ",", "eurekaTransport", ".", "transportClientFactory", ",", "clientConfig", ",", "transportConfig", ",", "applicationInfoManager", ".", "getInfo", "(", ")", ",", "applicationsSource", ")", ";", "newQueryClient", "=", "newQueryClientFactory", ".", "newClient", "(", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "eurekaTransport", ".", "queryClientFactory", "=", "newQueryClientFactory", ";", "eurekaTransport", ".", "queryClient", "=", "newQueryClient", ";", "}", "}", "</s>"]
["<s>", "public", "B", "withClientConfig", "(", "EurekaClientConfig", "clientConfig", ")", "{", "withClientAccept", "(", "EurekaAccept", ".", "fromString", "(", "clientConfig", ".", "getClientDataAccept", "(", ")", ")", ")", ";", "withAllowRedirect", "(", "clientConfig", ".", "allowRedirects", "(", ")", ")", ";", "withConnectionTimeout", "(", "clientConfig", ".", "getEurekaServerConnectTimeoutSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ";", "withReadTimeout", "(", "clientConfig", ".", "getEurekaServerReadTimeoutSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ";", "withMaxConnectionsPerHost", "(", "clientConfig", ".", "getEurekaServerTotalConnectionsPerHost", "(", ")", ")", ";", "withMaxTotalConnections", "(", "clientConfig", ".", "getEurekaServerTotalConnections", "(", ")", ")", ";", "withConnectionIdleTimeout", "(", "clientConfig", ".", "getEurekaConnectionIdleTimeoutSeconds", "(", ")", "*", "<NUM_LIT:1000>", ")", ";", "withEncoder", "(", "clientConfig", ".", "getEncoderName", "(", ")", ")", ";", "return", "withDecoder", "(", "clientConfig", ".", "getDecoderName", "(", ")", ",", "clientConfig", ".", "getClientDataAccept", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Deprecated", "public", "TransportClientFactory", "newTransportClientFactory", "(", "final", "Collection", "<", "ClientFilter", ">", "additionalFilters", ",", "final", "EurekaJerseyClient", "providedJerseyClient", ")", "{", "ApacheHttpClient4", "apacheHttpClient", "=", "providedJerseyClient", ".", "getClient", "(", ")", ";", "if", "(", "additionalFilters", "!", "=", "null", ")", "{", "for", "(", "ClientFilter", "filter", ":", "additionalFilters", ")", "{", "if", "(", "filter", "!", "=", "null", ")", "{", "apacheHttpClient", ".", "addFilter", "(", "filter", ")", ";", "}", "}", "}", "final", "TransportClientFactory", "jerseyFactory", "=", "new", "JerseyEurekaHttpClientFactory", "(", "providedJerseyClient", ",", "false", ")", ";", "final", "TransportClientFactory", "metricsFactory", "=", "MetricsCollectingEurekaHttpClient", ".", "createFactory", "(", "jerseyFactory", ")", ";", "return", "new", "TransportClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", "EurekaEndpoint", "serviceUrl", ")", "{", "return", "metricsFactory", ".", "newClient", "(", "serviceUrl", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "metricsFactory", ".", "shutdown", "(", ")", ";", "jerseyFactory", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "public", "TransportClientFactory", "newTransportClientFactory", "(", "final", "EurekaClientConfig", "clientConfig", ",", "final", "Collection", "<", "ClientFilter", ">", "additionalFilters", ",", "final", "InstanceInfo", "myInstanceInfo", ")", "{", "final", "TransportClientFactory", "jerseyFactory", "=", "JerseyEurekaHttpClientFactory", ".", "create", "(", "clientConfig", ",", "additionalFilters", ",", "myInstanceInfo", ",", "new", "EurekaClientIdentity", "(", "myInstanceInfo", ".", "getIPAddr", "(", ")", ")", ")", ";", "final", "TransportClientFactory", "metricsFactory", "=", "MetricsCollectingEurekaHttpClient", ".", "createFactory", "(", "jerseyFactory", ")", ";", "return", "new", "TransportClientFactory", "(", ")", "{", "@", "Override", "public", "EurekaHttpClient", "newClient", "(", "EurekaEndpoint", "serviceUrl", ")", "{", "return", "metricsFactory", ".", "newClient", "(", "serviceUrl", ")", ";", "}", "@", "Override", "public", "void", "shutdown", "(", ")", "{", "metricsFactory", ".", "shutdown", "(", ")", ";", "jerseyFactory", ".", "shutdown", "(", ")", ";", "}", "}", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "before", "(", ")", "{", "args", "=", "new", "DiscoveryClientOptionalArgs", "(", ")", ";", "}", "</s>"]
["<s>", "private", "boolean", "hasEntity", "(", "ClientRequestContext", "requestContext", ")", "{", "return", "false", ";", "}", "</s>"]
["<s>", "public", "static", "Jersey2ReplicationClient", "createReplicationClient", "(", "EurekaServerConfig", "config", ",", "ServerCodecs", "serverCodecs", ",", "String", "serviceUrl", ")", "{", "String", "name", "=", "Jersey2ReplicationClient", ".", "class", ".", "getSimpleName", "(", ")", "+", "\"", "<STR_LIT>", "\"", "+", "serviceUrl", "+", "\"", "<STR_LIT>", "\"", ";", "EurekaJersey2Client", "jerseyClient", ";", "try", "{", "String", "hostname", ";", "try", "{", "hostname", "=", "new", "URL", "(", "serviceUrl", ")", ".", "getHost", "(", ")", ";", "}", "catch", "(", "MalformedURLException", "e", ")", "{", "hostname", "=", "serviceUrl", ";", "}", "String", "jerseyClientName", "=", "\"", "<STR_LIT>", "\"", "+", "hostname", ";", "EurekaJersey2ClientImpl", ".", "EurekaJersey2ClientBuilder", "clientBuilder", "=", "new", "EurekaJersey2ClientImpl", ".", "EurekaJersey2ClientBuilder", "(", ")", ".", "withClientName", "(", "jerseyClientName", ")", ".", "withUserAgent", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withEncoderWrapper", "(", "serverCodecs", ".", "getFullJsonCodec", "(", ")", ")", ".", "withDecoderWrapper", "(", "serverCodecs", ".", "getFullJsonCodec", "(", ")", ")", ".", "withConnectionTimeout", "(", "config", ".", "getPeerNodeConnectTimeoutMs", "(", ")", ")", ".", "withReadTimeout", "(", "config", ".", "getPeerNodeReadTimeoutMs", "(", ")", ")", ".", "withMaxConnectionsPerHost", "(", "config", ".", "getPeerNodeTotalConnectionsPerHost", "(", ")", ")", ".", "withMaxTotalConnections", "(", "config", ".", "getPeerNodeTotalConnections", "(", ")", ")", ".", "withConnectionIdleTimeout", "(", "config", ".", "getPeerNodeConnectionIdleTimeoutSeconds", "(", ")", ")", ";", "if", "(", "serviceUrl", ".", "startsWith", "(", "\"", "<STR_LIT>", "\"", ")", "&", "&", "\"", "<STR_LIT>", "\"", ".", "equals", "(", "System", ".", "getProperty", "(", "\"", "<STR_LIT>", "\"", ")", ")", ")", "{", "clientBuilder", ".", "withSystemSSLConfiguration", "(", ")", ";", "}", "jerseyClient", "=", "clientBuilder", ".", "build", "(", ")", ";", "}", "catch", "(", "Throwable", "e", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "<STR_LIT>", "\"", "+", "name", ",", "e", ")", ";", "}", "String", "ip", "=", "null", ";", "try", "{", "ip", "=", "InetAddress", ".", "getLocalHost", "(", ")", ".", "getHostAddress", "(", ")", ";", "}", "catch", "(", "UnknownHostException", "e", ")", "{", "logger", ".", "warn", "(", "\"", "<STR_LIT>", "\"", ",", "e", ")", ";", "}", "Client", "jerseyApacheClient", "=", "jerseyClient", ".", "getClient", "(", ")", ";", "jerseyApacheClient", ".", "register", "(", "new", "Jersey2DynamicGZIPContentEncodingFilter", "(", "config", ")", ")", ";", "EurekaServerIdentity", "identity", "=", "new", "EurekaServerIdentity", "(", "ip", ")", ";", "jerseyApacheClient", ".", "register", "(", "new", "EurekaIdentityHeaderFilter", "(", "identity", ")", ")", ";", "return", "new", "Jersey2ReplicationClient", "(", "jerseyClient", ",", "serviceUrl", ")", ";", "}", "</s>"]
["<s>", "private", "static", "boolean", "isSuccess", "(", "int", "statusCode", ")", "{", "return", "statusCode", ">", "=", "<NUM_LIT>", "&", "&", "statusCode", "<", "<NUM_LIT>", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "replicationClient", "=", "Jersey2ReplicationClient", ".", "createReplicationClient", "(", "config", ",", "serverCodecs", ",", "\"", "<STR_LIT>", "\"", "+", "serverMockRule", ".", "getHttpPort", "(", ")", "+", "\"", "<STR_LIT>", "\"", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "if", "(", "serverMockClient", "!", "=", "null", ")", "{", "serverMockClient", ".", "reset", "(", ")", ";", "}", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testRegistrationReplication", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT:POST>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getAppName", "(", ")", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "response", "=", "replicationClient", ".", "register", "(", "instanceInfo", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testCancelReplication", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getAppName", "(", ")", "+", "<CHAR_LIT:/>", "+", "instanceInfo", ".", "getId", "(", ")", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "response", "=", "replicationClient", ".", "cancel", "(", "instanceInfo", ".", "getAppName", "(", ")", ",", "instanceInfo", ".", "getId", "(", ")", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHeartbeatReplicationWithNoResponseBody", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getAppName", "(", ")", "+", "<CHAR_LIT:/>", "+", "instanceInfo", ".", "getId", "(", ")", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "InstanceInfo", ">", "response", "=", "replicationClient", ".", "sendHeartBeat", "(", "instanceInfo", ".", "getAppName", "(", ")", ",", "instanceInfo", ".", "getId", "(", ")", ",", "instanceInfo", ",", "InstanceStatus", ".", "DOWN", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "assertThat", "(", "response", ".", "getEntity", "(", ")", ",", "is", "(", "nullValue", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHeartbeatReplicationWithResponseBody", "(", ")", "throws", "Exception", "{", "InstanceInfo", "remoteInfo", "=", "new", "InstanceInfo", "(", "this", ".", "instanceInfo", ")", ";", "remoteInfo", ".", "setStatus", "(", "InstanceStatus", ".", "DOWN", ")", ";", "byte", "[", "]", "responseBody", "=", "toGzippedJson", "(", "remoteInfo", ")", ";", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "this", ".", "instanceInfo", ".", "getAppName", "(", ")", "+", "<CHAR_LIT:/>", "+", "this", ".", "instanceInfo", ".", "getId", "(", ")", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "Status", ".", "CONFLICT", ".", "getStatusCode", "(", ")", ")", ".", "withHeader", "(", "header", "(", "\"", "<STR_LIT:Content-Type>", "\"", ",", "MediaType", ".", "APPLICATION_JSON", ")", ")", ".", "withHeader", "(", "header", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withBody", "(", "responseBody", ")", ")", ";", "EurekaHttpResponse", "<", "InstanceInfo", ">", "response", "=", "replicationClient", ".", "sendHeartBeat", "(", "this", ".", "instanceInfo", ".", "getAppName", "(", ")", ",", "this", ".", "instanceInfo", ".", "getId", "(", ")", ",", "this", ".", "instanceInfo", ",", "null", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "Status", ".", "CONFLICT", ".", "getStatusCode", "(", ")", ")", ")", ")", ";", "assertThat", "(", "response", ".", "getEntity", "(", ")", ",", "is", "(", "notNullValue", "(", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testAsgStatusUpdateReplication", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getASGName", "(", ")", "+", "\"", "<STR_LIT>", "\"", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "response", "=", "replicationClient", ".", "statusUpdate", "(", "instanceInfo", ".", "getASGName", "(", ")", ",", "ASGStatus", ".", "ENABLED", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testStatusUpdateReplication", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getAppName", "(", ")", "+", "<CHAR_LIT:/>", "+", "instanceInfo", ".", "getId", "(", ")", "+", "\"", "<STR_LIT>", "\"", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "response", "=", "replicationClient", ".", "statusUpdate", "(", "instanceInfo", ".", "getAppName", "(", ")", ",", "instanceInfo", ".", "getId", "(", ")", ",", "InstanceStatus", ".", "DOWN", ",", "instanceInfo", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testDeleteStatusOverrideReplication", "(", ")", "throws", "Exception", "{", "serverMockClient", ".", "when", "(", "request", "(", ")", ".", "withMethod", "(", "\"", "<STR_LIT>", "\"", ")", ".", "withHeader", "(", "header", "(", "PeerEurekaNode", ".", "HEADER_REPLICATION", ",", "\"", "<STR_LIT>", "\"", ")", ")", ".", "withPath", "(", "\"", "<STR_LIT>", "\"", "+", "instanceInfo", ".", "getAppName", "(", ")", "+", "<CHAR_LIT:/>", "+", "instanceInfo", ".", "getId", "(", ")", "+", "\"", "<STR_LIT>", "\"", ")", ")", ".", "respond", "(", "response", "(", ")", ".", "withStatusCode", "(", "<NUM_LIT>", ")", ")", ";", "EurekaHttpResponse", "<", "Void", ">", "response", "=", "replicationClient", ".", "deleteStatusOverride", "(", "instanceInfo", ".", "getAppName", "(", ")", ",", "instanceInfo", ".", "getId", "(", ")", ",", "instanceInfo", ")", ";", "assertThat", "(", "response", ".", "getStatusCode", "(", ")", ",", "is", "(", "equalTo", "(", "<NUM_LIT>", ")", ")", ")", ";", "}", "</s>"]
["<s>", "private", "static", "byte", "[", "]", "toGzippedJson", "(", "InstanceInfo", "remoteInfo", ")", "throws", "IOException", "{", "ByteArrayOutputStream", "bos", "=", "new", "ByteArrayOutputStream", "(", ")", ";", "GZIPOutputStream", "gos", "=", "new", "GZIPOutputStream", "(", "bos", ")", ";", "EurekaJacksonCodec", ".", "getInstance", "(", ")", ".", "writeTo", "(", "remoteInfo", ",", "gos", ")", ";", "gos", ".", "flush", "(", ")", ";", "return", "bos", ".", "toByteArray", "(", ")", ";", "}", "</s>"]
["<s>", "protected", "void", "setDiscoveryClient", "(", "DiscoveryClient", "discoveryClient", ")", "{", "this", ".", "discoveryClient", "=", "discoveryClient", ";", "}", "</s>"]
["<s>", "protected", "PeerEurekaNodes", "getPeerEurekaNodes", "(", "PeerAwareInstanceRegistry", "registry", ",", "EurekaServerConfig", "eurekaServerConfig", ",", "EurekaClientConfig", "eurekaClientConfig", ",", "ServerCodecs", "serverCodecs", ",", "ApplicationInfoManager", "applicationInfoManager", ")", "{", "PeerEurekaNodes", "peerEurekaNodes", "=", "new", "PeerEurekaNodes", "(", "registry", ",", "eurekaServerConfig", ",", "eurekaClientConfig", ",", "serverCodecs", ",", "applicationInfoManager", ")", ";", "return", "peerEurekaNodes", ";", "}", "</s>"]
["<s>", "public", "boolean", "isInstanceURL", "(", "String", "url", ",", "InstanceInfo", "instance", ")", "{", "String", "hostName", "=", "hostFromUrl", "(", "url", ")", ";", "String", "myInfoComparator", "=", "instance", ".", "getHostName", "(", ")", ";", "if", "(", "clientConfig", ".", "getTransportConfig", "(", ")", ".", "applicationsResolverUseIp", "(", ")", ")", "{", "myInfoComparator", "=", "instance", ".", "getIPAddr", "(", ")", ";", "}", "return", "hostName", "!", "=", "null", "&", "&", "hostName", ".", "equals", "(", "myInfoComparator", ")", ";", "}", "</s>"]
["<s>", "public", "int", "getMinNumberOfAvailablePeers", "(", ")", "{", "return", "serverConfig", ".", "getMinNumberOfAvailablePeers", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetStatusInfoHealthy", "(", ")", "{", "StatusUtil", "statusUtil", "=", "getStatusUtil", "(", "<NUM_LIT:3>", ",", "<NUM_LIT:3>", ",", "<NUM_LIT:2>", ")", ";", "assertTrue", "(", "statusUtil", ".", "getStatusInfo", "(", ")", ".", "isHealthy", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetStatusInfoUnhealthy", "(", ")", "{", "StatusUtil", "statusUtil", "=", "getStatusUtil", "(", "<NUM_LIT:5>", ",", "<NUM_LIT:3>", ",", "<NUM_LIT:4>", ")", ";", "assertFalse", "(", "statusUtil", ".", "getStatusInfo", "(", ")", ".", "isHealthy", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testGetStatusInfoUnsetHealth", "(", ")", "{", "StatusUtil", "statusUtil", "=", "getStatusUtil", "(", "<NUM_LIT:5>", ",", "<NUM_LIT:3>", ",", "0", ")", ";", "StatusInfo", "statusInfo", "=", "statusUtil", ".", "getStatusInfo", "(", ")", ";", "try", "{", "statusInfo", ".", "isHealthy", "(", ")", ";", "}", "catch", "(", "NullPointerException", "e", ")", "{", "return", ";", "}", "fail", "(", "\"", "<STR_LIT>", "\"", ")", ";", "}", "</s>"]
["<s>", "private", "StatusUtil", "getStatusUtil", "(", "int", "replicas", ",", "int", "instances", ",", "int", "minimum", ")", "{", "EurekaServerContext", "mockEurekaServerContext", "=", "mock", "(", "EurekaServerContext", ".", "class", ")", ";", "List", "<", "InstanceInfo", ">", "mockInstanceInfos", "=", "getMockInstanceInfos", "(", "instances", ")", ";", "Application", "mockApplication", "=", "mock", "(", "Application", ".", "class", ")", ";", "when", "(", "mockApplication", ".", "getInstances", "(", ")", ")", ".", "thenReturn", "(", "mockInstanceInfos", ")", ";", "PeerAwareInstanceRegistry", "mockRegistry", "=", "mock", "(", "PeerAwareInstanceRegistry", ".", "class", ")", ";", "when", "(", "mockRegistry", ".", "getApplication", "(", "\"", "<STR_LIT>", "\"", ",", "false", ")", ")", ".", "thenReturn", "(", "mockApplication", ")", ";", "when", "(", "mockEurekaServerContext", ".", "getRegistry", "(", ")", ")", ".", "thenReturn", "(", "mockRegistry", ")", ";", "List", "<", "PeerEurekaNode", ">", "mockNodes", "=", "getMockNodes", "(", "replicas", ")", ";", "PeerEurekaNodes", "mockPeerEurekaNodes", "=", "mock", "(", "PeerEurekaNodes", ".", "class", ")", ";", "when", "(", "mockPeerEurekaNodes", ".", "getMinNumberOfAvailablePeers", "(", ")", ")", ".", "thenReturn", "(", "minimum", ")", ";", "when", "(", "mockPeerEurekaNodes", ".", "getPeerEurekaNodes", "(", ")", ")", ".", "thenReturn", "(", "mockNodes", ")", ";", "when", "(", "mockEurekaServerContext", ".", "getPeerEurekaNodes", "(", ")", ")", ".", "thenReturn", "(", "mockPeerEurekaNodes", ")", ";", "ApplicationInfoManager", "mockAppInfoManager", "=", "mock", "(", "ApplicationInfoManager", ".", "class", ")", ";", "when", "(", "mockAppInfoManager", ".", "getInfo", "(", ")", ")", ".", "thenReturn", "(", "mockInstanceInfos", ".", "get", "(", "0", ")", ")", ";", "when", "(", "mockEurekaServerContext", ".", "getApplicationInfoManager", "(", ")", ")", ".", "thenReturn", "(", "mockAppInfoManager", ")", ";", "return", "new", "StatusUtil", "(", "mockEurekaServerContext", ")", ";", "}", "</s>"]
["<s>", "List", "<", "InstanceInfo", ">", "getMockInstanceInfos", "(", "int", "size", ")", "{", "List", "<", "InstanceInfo", ">", "instances", "=", "new", "ArrayList", "<", ">", "(", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "size", ";", "i", "+", "+", ")", "{", "InstanceInfo", "mockInstance", "=", "mock", "(", "InstanceInfo", ".", "class", ")", ";", "when", "(", "mockInstance", ".", "getHostName", "(", ")", ")", ".", "thenReturn", "(", "String", ".", "valueOf", "(", "i", ")", ")", ";", "when", "(", "mockInstance", ".", "getIPAddr", "(", ")", ")", ".", "thenReturn", "(", "String", ".", "valueOf", "(", "i", ")", ")", ";", "when", "(", "mockInstance", ".", "getAppName", "(", ")", ")", ".", "thenReturn", "(", "\"", "<STR_LIT>", "\"", ")", ";", "instances", ".", "add", "(", "mockInstance", ")", ";", "}", "return", "instances", ";", "}", "</s>"]
["<s>", "List", "<", "PeerEurekaNode", ">", "getMockNodes", "(", "int", "size", ")", "{", "List", "<", "PeerEurekaNode", ">", "nodes", "=", "new", "ArrayList", "<", ">", "(", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "size", ";", "i", "+", "+", ")", "{", "PeerEurekaNode", "mockNode", "=", "mock", "(", "PeerEurekaNode", ".", "class", ")", ";", "when", "(", "mockNode", ".", "getServiceUrl", "(", ")", ")", ".", "thenReturn", "(", "String", ".", "format", "(", "\"", "<STR_LIT>", "\"", ",", "i", ")", ")", ";", "nodes", ".", "add", "(", "mockNode", ")", ";", "}", "return", "nodes", ";", "}", "</s>"]
["<s>", "@", "Provides", "public", "TransportClientFactories", "getTransportClientFactories", "(", ")", "{", "return", "Jersey2TransportClientFactories", ".", "getInstance", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "setProperty", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ";", "injector", "=", "InjectorBuilder", ".", "fromModule", "(", "new", "Jersey2EurekaModule", "(", ")", ")", ".", "overrideWith", "(", "new", "AbstractModule", "(", ")", "{", "@", "Override", "protected", "void", "configure", "(", ")", "{", "bind", "(", "EurekaInstanceConfig", ".", "class", ")", ".", "toProvider", "(", "MyDataCenterInstanceConfigProvider", ".", "class", ")", ".", "in", "(", "Scopes", ".", "SINGLETON", ")", ";", "}", "}", ")", ".", "createInjector", "(", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "if", "(", "injector", "!", "=", "null", ")", "{", "injector", ".", "shutdown", "(", ")", ";", "}", "ConfigurationManager", ".", "getConfigInstance", "(", ")", ".", "clear", "(", ")", ";", "}", "</s>"]
["<s>", "@", "SuppressWarnings", "(", "\"", "<STR_LIT>", "\"", ")", "@", "Test", "public", "void", "testDI", "(", ")", "{", "InstanceInfo", "instanceInfo", "=", "injector", ".", "getInstance", "(", "InstanceInfo", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "ApplicationInfoManager", ".", "getInstance", "(", ")", ".", "getInfo", "(", ")", ",", "instanceInfo", ")", ";", "EurekaClient", "eurekaClient", "=", "injector", ".", "getInstance", "(", "EurekaClient", ".", "class", ")", ";", "DiscoveryClient", "discoveryClient", "=", "injector", ".", "getInstance", "(", "DiscoveryClient", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClient", "(", ")", ",", "eurekaClient", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getDiscoveryClient", "(", ")", ",", "discoveryClient", ")", ";", "Assert", ".", "assertEquals", "(", "eurekaClient", ",", "discoveryClient", ")", ";", "EurekaClientConfig", "eurekaClientConfig", "=", "injector", ".", "getInstance", "(", "EurekaClientConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClientConfig", "(", ")", ",", "eurekaClientConfig", ")", ";", "EurekaInstanceConfig", "eurekaInstanceConfig", "=", "injector", ".", "getInstance", "(", "EurekaInstanceConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaInstanceConfig", "(", ")", ",", "eurekaInstanceConfig", ")", ";", "Binding", "<", "TransportClientFactories", ">", "binding", "=", "injector", ".", "getExistingBinding", "(", "Key", ".", "get", "(", "TransportClientFactories", ".", "class", ")", ")", ";", "Assert", ".", "assertNotNull", "(", "binding", ")", ";", "TransportClientFactories", "transportClientFactories", "=", "injector", ".", "getInstance", "(", "TransportClientFactories", ".", "class", ")", ";", "Assert", ".", "assertTrue", "(", "transportClientFactories", "instanceof", "Jersey2TransportClientFactories", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "before", "(", ")", "{", "args", "=", "new", "Jersey1DiscoveryClientOptionalArgs", "(", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckCallbackGuiceProvider", "(", ")", "{", "args", ".", "setHealthCheckCallbackProvider", "(", "new", "GuiceProvider", "<", "HealthCheckCallback", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckCallbackJavaxProvider", "(", ")", "{", "args", ".", "setHealthCheckCallbackProvider", "(", "new", "JavaxProvider", "<", "HealthCheckCallback", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckHandlerGuiceProvider", "(", ")", "{", "args", ".", "setHealthCheckHandlerProvider", "(", "new", "GuiceProvider", "<", "HealthCheckHandler", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Test", "public", "void", "testHealthCheckHandlerJavaxProvider", "(", ")", "{", "args", ".", "setHealthCheckHandlerProvider", "(", "new", "JavaxProvider", "<", "HealthCheckHandler", ">", "(", ")", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "injector", "=", "InjectorBuilder", ".", "fromModules", "(", "new", "ArchaiusModule", "(", ")", "{", "@", "Override", "protected", "void", "configureArchaius", "(", ")", "{", "bindApplicationConfigurationOverride", "(", ")", ".", "toInstance", "(", "MapConfig", ".", "builder", "(", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ")", ";", "}", "}", ",", "new", "Ec2EurekaClientModule", "(", ")", ")", ".", "createInjector", "(", ")", ";", "}", "</s>"]
["<s>", "@", "After", "public", "void", "tearDown", "(", ")", "{", "if", "(", "injector", "!", "=", "null", ")", "{", "injector", ".", "shutdown", "(", ")", ";", "}", "}", "</s>"]
["<s>", "@", "SuppressWarnings", "(", "\"", "<STR_LIT>", "\"", ")", "@", "Test", "public", "void", "testDI", "(", ")", "{", "InstanceInfo", "instanceInfo", "=", "injector", ".", "getInstance", "(", "InstanceInfo", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "ApplicationInfoManager", ".", "getInstance", "(", ")", ".", "getInfo", "(", ")", ",", "instanceInfo", ")", ";", "VipAddressResolver", "vipAddressResolver", "=", "injector", ".", "getInstance", "(", "VipAddressResolver", ".", "class", ")", ";", "Assert", ".", "assertTrue", "(", "vipAddressResolver", "instanceof", "Archaius2VipAddressResolver", ")", ";", "EurekaClient", "eurekaClient", "=", "injector", ".", "getInstance", "(", "EurekaClient", ".", "class", ")", ";", "DiscoveryClient", "discoveryClient", "=", "injector", ".", "getInstance", "(", "DiscoveryClient", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClient", "(", ")", ",", "eurekaClient", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getDiscoveryClient", "(", ")", ",", "discoveryClient", ")", ";", "Assert", ".", "assertEquals", "(", "eurekaClient", ",", "discoveryClient", ")", ";", "EurekaClientConfig", "eurekaClientConfig", "=", "injector", ".", "getInstance", "(", "EurekaClientConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClientConfig", "(", ")", ",", "eurekaClientConfig", ")", ";", "EurekaInstanceConfig", "eurekaInstanceConfig", "=", "injector", ".", "getInstance", "(", "EurekaInstanceConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaInstanceConfig", "(", ")", ",", "eurekaInstanceConfig", ")", ";", "Assert", ".", "assertTrue", "(", "eurekaInstanceConfig", "instanceof", "Ec2EurekaArchaius2InstanceConfig", ")", ";", "}", "</s>"]
["<s>", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "injector", "=", "InjectorBuilder", ".", "fromModules", "(", "new", "ArchaiusModule", "(", ")", "{", "@", "Override", "protected", "void", "configureArchaius", "(", ")", "{", "bindApplicationConfigurationOverride", "(", ")", ".", "toInstance", "(", "MapConfig", ".", "builder", "(", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "put", "(", "\"", "<STR_LIT>", "\"", ",", "\"", "<STR_LIT>", "\"", ")", ".", "build", "(", ")", ")", ";", "}", "}", ",", "new", "LocalDevEurekaClientModule", "(", ")", ")", ".", "createInjector", "(", ")", ";", "}", "</s>"]
["<s>", "@", "SuppressWarnings", "(", "\"", "<STR_LIT>", "\"", ")", "@", "Test", "public", "void", "testDI", "(", ")", "{", "InstanceInfo", "instanceInfo", "=", "injector", ".", "getInstance", "(", "InstanceInfo", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "ApplicationInfoManager", ".", "getInstance", "(", ")", ".", "getInfo", "(", ")", ",", "instanceInfo", ")", ";", "VipAddressResolver", "vipAddressResolver", "=", "injector", ".", "getInstance", "(", "VipAddressResolver", ".", "class", ")", ";", "Assert", ".", "assertTrue", "(", "vipAddressResolver", "instanceof", "Archaius2VipAddressResolver", ")", ";", "EurekaClient", "eurekaClient", "=", "injector", ".", "getInstance", "(", "EurekaClient", ".", "class", ")", ";", "DiscoveryClient", "discoveryClient", "=", "injector", ".", "getInstance", "(", "DiscoveryClient", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClient", "(", ")", ",", "eurekaClient", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getDiscoveryClient", "(", ")", ",", "discoveryClient", ")", ";", "Assert", ".", "assertEquals", "(", "eurekaClient", ",", "discoveryClient", ")", ";", "EurekaClientConfig", "eurekaClientConfig", "=", "injector", ".", "getInstance", "(", "EurekaClientConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaClientConfig", "(", ")", ",", "eurekaClientConfig", ")", ";", "EurekaInstanceConfig", "eurekaInstanceConfig", "=", "injector", ".", "getInstance", "(", "EurekaInstanceConfig", ".", "class", ")", ";", "Assert", ".", "assertEquals", "(", "DiscoveryManager", ".", "getInstance", "(", ")", ".", "getEurekaInstanceConfig", "(", ")", ",", "eurekaInstanceConfig", ")", ";", "Assert", ".", "assertTrue", "(", "eurekaInstanceConfig", "instanceof", "EurekaArchaius2InstanceConfig", ")", ";", "Assert", ".", "assertFalse", "(", "eurekaInstanceConfig", "instanceof", "Ec2EurekaArchaius2InstanceConfig", ")", ";", "}", "</s>"]
["<s>", "public", "Builder", "withAmazonInfoConfig", "(", "AmazonInfoConfig", "config", ")", "{", "this", ".", "config", "=", "config", ";", "return", "this", ";", "}", "</s>"]
["<s>", "public", "boolean", "shouldValidateInstanceId", "(", ")", "{", "return", "configInstance", ".", "getBooleanProperty", "(", "namespace", "+", "\"", "<STR_LIT>", "\"", ",", "true", ")", ".", "get", "(", ")", ";", "}", "</s>"]
